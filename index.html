<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#202c33">
    <title>Control de Pagos</title>

    <style>
        /* --- VARIABLES & THEME --- */
        :root {
            /* Light Mode */
            --bg-app: #f4f7f6;
            --bg-sidebar: #ffffff;
            --bg-panel: #ffffff;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --accent: #0984e3;
            /* Modern Blue */
            --accent-hover: #74b9ff;
            --border-color: #dfe6e9;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --card-radius: 12px;

            /* Status Colors */
            --status-paid-bg: #e0fadc;
            /* Softer Green */
            --status-paid-text: #25bb39;
            --status-pending-bg: #fff3e0;
            --status-pending-text: #f39c12;
            --status-overdue-bg: #ffebee;
            --status-overdue-text: #e74c3c;

            /* Calendar specific */
            --cal-bg: #ffffff;
            --cal-header: #f8f9fa;
            --cal-border: #dfe6e9;
            --day-hover: #f1f2f6;

            /* Checklist Item Colors (Light) */
            --chk-bg-overdue: #ffebee;
            --chk-text-overdue: #c62828;
            --chk-border-overdue: #e53935;

            --chk-bg-upcoming: #fff3e0;
            --chk-text-upcoming: #ef6c00;
            --chk-border-upcoming: #fb8c00;

            --chk-bg-future: #e3f2fd;
            --chk-text-future: #1565c0;
            --chk-border-future: #1e88e5;

            --chk-bg-default: var(--bg-panel);
            --chk-text-default: var(--text-primary);
        }

        body.dark-mode {
            /* iOS Dark Mode Standard */
            --bg-app: #000000;
            --bg-sidebar: #1C1C1E;
            /* iOS Card/Modal BG */
            --bg-panel: #1C1C1E;
            --text-primary: #FFFFFF;
            --text-secondary: #EBEBF5;
            /* iOS High Contrast Light Grey */
            /* iOS System Gray */
            --accent: #0A84FF;
            /* iOS System Blue Dark Mode */
            --accent-hover: #409CFF;
            --border-color: #38383A;
            /* Subtler border */
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            /* Heavier shadow for depth */

            --status-paid-bg: rgba(48, 209, 88, 0.2);
            --status-paid-text: #30D158;
            /* iOS Green */
            --status-pending-bg: rgba(255, 159, 10, 0.2);
            --status-pending-text: #FF9F0A;
            /* iOS Orange */
            --status-overdue-bg: rgba(255, 69, 58, 0.2);
            --status-overdue-text: #FF453A;
            /* iOS Red */

            --cal-bg: #1C1C1E;
            --cal-header: #2C2C2E;
            --cal-border: #38383A;
            --day-hover: #2C2C2E;

            /* Checklist Item Colors (Dark) */
            --chk-bg-overdue: rgba(255, 69, 58, 0.15);
            --chk-text-overdue: #FF453A;
            --chk-border-overdue: #FF453A;

            --chk-bg-upcoming: rgba(255, 159, 10, 0.15);
            --chk-text-upcoming: #FF9F0A;
            --chk-border-upcoming: #FF9F0A;

            --chk-bg-future: rgba(10, 132, 255, 0.15);
            --chk-text-future: #0A84FF;
            --chk-border-future: #0A84FF;

            --chk-bg-default: var(--bg-panel);
            --chk-text-default: var(--text-primary);
        }

        /* FORCE WHITE TEXT IN DARK MODE FOR ALL ELEMENTS */
        /* FORCE WHITE TEXT IN DARK MODE FOR ALL ELEMENTS */
        body.dark-mode {
            color: var(--text-primary);
            /* Base fallback */
        }

        body.dark-mode * {
            border-color: var(--border-color);
        }

        /* Specific High-Contrast Overrides */
        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode h3,
        body.dark-mode h4,
        body.dark-mode h5,
        body.dark-mode h6,
        body.dark-mode strong,
        body.dark-mode b,
        body.dark-mode label,
        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea,
        body.dark-mode .card-title,
        body.dark-mode .item,
        body.dark-mode .nav-btn,
        body.dark-mode button,
        body.dark-mode .gasto,
        body.dark-mode li,
        body.dark-mode span,
        body.dark-mode div {
            color: var(--text-primary) !important;
        }

        /* Exceptions for specific colored elements */
        body.dark-mode .text-secondary,
        body.dark-mode .card-meta,
        body.dark-mode .note-header,
        body.dark-mode .header {
            color: var(--text-secondary) !important;
        }

        /* Ensure placeholders are visible */
        body.dark-mode ::placeholder {
            color: var(--text-secondary);
            opacity: 1;
        }

        /* Colored Status Overrides (Must have higher specificity) */
        body.dark-mode .pendiente {
            color: #ffcc80 !important;
        }

        body.dark-mode .pagado {
            color: #a5d6a7 !important;
        }

        body.dark-mode .vencido {
            color: #ef9a9a !important;
        }

        body.dark-mode .agenda-item {
            color: #64b5f6 !important;
        }

        /* SPECIFIC FIXES */
        body.dark-mode select option {
            background-color: var(--bg-panel);
            color: var(--text-primary);
        }

        * {
            box-sizing: border-box;
        }

        /* Fix for copy/paste issues */
        input,
        textarea {
            -webkit-user-select: text !important;
            user-select: text !important;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #000;
            /* Dark background for desktop wrapper */
            margin: 0;
            height: 100vh;
            height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- LAYOUT --- */
        .app-container {
            display: flex;
            flex-direction: column-reverse;
            /* Bottom Nav */
            width: 100%;
            max-width: 430px;
            /* iPhone Pro Max width */
            height: 100%;
            max-height: 932px;
            /* iPhone Pro Max height */
            background: var(--bg-app);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        /* --- BOTTOM NAVIGATION (Previously Sidebar) --- */
        .sidebar {
            width: 100%;
            height: auto;
            min-height: 80px;
            /* Taller for safe area */
            background: var(--bg-sidebar);
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            align-items: flex-start;
            /* Align icons top */
            padding-top: 12px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            border-top: 1px solid var(--border-color);
            z-index: 100;
            flex-shrink: 0;
        }

        .nav-btn {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            background: transparent;
            border: none;
            flex-direction: column;
            gap: 4px;
        }

        .nav-btn:hover {
            background: transparent;
            color: var(--accent);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            color: var(--accent);
            background: transparent;
            box-shadow: none;
        }

        .nav-btn.active svg {
            fill: var(--accent);
            filter: drop-shadow(0 2px 4px rgba(var(--accent-rgb), 0.3));
        }

        .nav-btn svg {
            width: 26px;
            /* Larger icons */
            height: 26px;
            fill: currentColor;
            transition: fill 0.2s;
        }

        /* Optional labels for bottom nav? User wanted minimalist. Keeping icons only for now or small labels if needed. */

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-app);
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        .top-bar {
            height: 60px;
            /* Standard mobile header */
            min-height: 60px;
            background: var(--bg-panel);
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid var(--border-color);
            justify-content: space-between;
            padding-top: max(10px, env(safe-area-inset-top));
            /* Safe area */
            z-index: 10;
        }

        .top-bar h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* Hidden Filters */
        #filter-overlay {
            display: none;
            position: absolute;
            top: 70px;
            /* Below top bar */
            left: 0;
            width: 100%;
            background: var(--bg-panel);
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 20;
            border-bottom: 1px solid var(--border-color);
            flex-direction: column;
            gap: 10px;
        }

        #filter-overlay.open {
            display: flex;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Fixed Mobile Selects - Cleaner look */
        select {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-app);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            width: 100%;
            /* Full width in overlay */
        }

        /* --- VIEWS --- */
        .view-section {
            display: none;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            height: 100%;
            box-sizing: border-box;
            background: var(--bg-app);
            -webkit-overflow-scrolling: touch;
            /* Smooth scroll */
            padding-bottom: 20px;
            /* Space above nav */
        }

        .view-section.active {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- DASHBOARD REDESIGN (Mobile Focused & Clean) --- */
        .dashboard-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
            /* More breathing room */
            padding-bottom: 100px;
            /* More bottom space */
        }

        .db-header-card {
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            color: white;
            padding: 25px;
            /* More padding */
            border-radius: 20px;
            /* Softer corners */
            box-shadow: 0 8px 25px rgba(9, 132, 227, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .db-stat .label {
            font-size: 11px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .db-stat .value {
            font-size: 24px;
            font-weight: 700;
            margin-top: 5px;
        }

        .dashboard-section {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .dashboard-section.wide {
            grid-column: 1 / -1;
        }

        .dashboard-section h3 {
            font-size: 15px;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .dashboard-card {
            background: var(--bg-app);
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            background: var(--bg-sidebar);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .dashboard-card.overdue {
            background: var(--status-overdue-bg);
            border-left: 4px solid var(--status-overdue-text);
        }

        .dashboard-card.overdue .card-title {
            color: var(--status-overdue-text);
        }

        .dashboard-card.upcoming {
            background: var(--bg-app);
            border-left: 4px solid var(--accent);
        }

        .checkbox-card {
            padding: 8px 12px;
            /* Minimalist compact padding */
            min-height: 50px;
            display: flex;
            flex-direction: row !important;
            /* Force row layout */
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            text-align: left;
            /* Ensure text is left aligned */
        }

        .checkbox-card .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
            align-items: flex-start;
            /* Align content to start */
        }

        .checkbox-card .card-action {
            display: flex;
            align-items: center;
        }

        .card-title {
            font-weight: 600;
            font-size: 14px;
            /* Slightly smaller for minimalism */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-meta {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .custom-checkbox {
            width: 22px;
            height: 22px;
            accent-color: var(--status-paid-text);
            cursor: pointer;
            flex-shrink: 0;
        }

        /* --- CHECKLIST LISTA --- */
        .checklist-container {
            background: var(--bg-panel);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            padding-top: 20px;
            height: 100%;
        }

        .checklist-header {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 15px 0;
            padding: 0 15px;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item:hover {
            background: var(--bg-app);
        }

        .item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent);
            border-radius: 4px;
            /* Attempt to style check */
        }

        /* --- CALENDAR --- */
        /* --- VIEWS --- */
        .view-section {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            height: 100%;
            /* Force full height */
            box-sizing: border-box;
        }

        .view-section.active {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* --- CALENDAR CLEANUP (Mobile) --- */
        .calendar-wrapper {
            background: var(--bg-panel);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .day {
            background: var(--bg-panel);
            padding: 4px;
            /* Reduce padding to fit dots */
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Center date and dots */
            min-height: 0;
            overflow: hidden;
        }

        .day strong {
            width: 24px;
            height: 24px;
            font-size: 12px;
            margin-bottom: 2px;
        }

        /* Event Indicator (Dot) */
        .gasto {
            width: 8px;
            height: 8px;
            padding: 0;
            border-radius: 50%;
            margin: 1px;
            text-indent: -9999px;
            /* Hide text */
            border: none;
            display: inline-block;
        }

        .gasto:hover {
            transform: scale(1.5);
            z-index: 2;
        }

        .calendar {
            gap: 0;
            /* Seamless */
            border: none;
        }

        /* Container for dots */
        .dots-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2px;
            width: 100%;
        }

        /* LIGHT MODE COLORS */
        .pendiente {
            background: rgba(255, 159, 67, 0.2);
            color: #d35400;
            border-left: 3px solid #d35400;
        }

        .pagado {
            background: rgba(46, 204, 113, 0.2);
            color: #27ae60;
            border-left: 3px solid #27ae60;
            text-decoration: none;
            opacity: 1;
        }

        .vencido {
            background: rgba(231, 76, 60, 0.2) !important;
            color: #c0392b !important;
            border-left: 3px solid #c0392b;
        }

        /* DARK MODE OVERRIDES */
        body.dark-mode .pendiente {
            background: rgba(211, 84, 0, 0.25);
            color: #ffcc80;
            border-left: 3px solid #e67e22;
        }

        body.dark-mode .pagado {
            background: rgba(39, 174, 96, 0.25);
            color: #a5d6a7;
            border-left: 3px solid #2ecc71;
        }

        body.dark-mode .vencido {
            background: rgba(192, 57, 43, 0.25) !important;
            color: #ef9a9a !important;
            border-left: 3px solid #e74c3c;
        }

        /* CALENDAR GRID FIX */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: 1fr;
            /* Equal height rows filling space */
            gap: 1px;
            background: var(--border-color);
            /* Grid lines */
            height: 100%;
            padding: 1px;
            /* Show outer border */
            overflow: hidden;
            /* No scroll inside */
        }

        .day {
            background: var(--bg-panel);
            /* Cell bg */
            padding: 8px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            /* Allow shrink */
            overflow: hidden;
        }

        .day.empty {
            background: var(--bg-app);
            /* Slightly different for empty */
        }

        .header {
            background: var(--bg-panel);
            padding: 10px;
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        /* --- SETTINGS --- */
        .settings-container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--bg-panel);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .btn-toggle {
            background: var(--text-secondary);
            color: var(--bg-panel);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn-toggle.active {
            background: var(--accent);
            color: white;
        }

        /* AGENDA ITEM IN CALENDAR */
        .agenda-item {
            background: rgba(33, 150, 243, 0.15) !important;
            color: #1976d2 !important;
        }

        body.dark-mode .agenda-item {
            background: rgba(33, 150, 243, 0.2) !important;
            color: #64b5f6 !important;
        }

        /* --- MOBILE --- */
        /* Hide Media Queries as we are enforcing mobile layout globally */
        /* @media (max-width: 700px) ... REMOVED/ADAPTED */

        /* --- AGENDA VIEW --- */
        .agenda-container {
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 80px;
            /* Space for content */
        }

        .agenda-input-area {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }

        .agenda-input {
            flex: 1;
            border-radius: 10px;
            padding: 12px;
            font-size: 15px;
            /* Better input size */
            border: 1px solid var(--border-color);
            background: var(--bg-sidebar);
            color: var(--text-primary);
            outline: none;
        }

        .agenda-date {
            padding: 8px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            background: var(--bg-sidebar);
            color: var(--text-primary);
            font-size: 12px;
            font-family: inherit;
        }

        .btn-add {
            background: var(--accent);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .note-card {
            background: var(--bg-panel);
            margin: 10px 15px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .note-body {
            font-size: 15px;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .btn-delete-note {
            background: transparent;
            border: none;
            color: #ef5350;
            font-size: 18px;
            cursor: pointer;
            padding: 0 5px;
        }

        /* --- DASHBOARD --- */
        .dashboard-container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        .dashboard-section {
            margin-bottom: 30px;
        }

        .dashboard-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            /* Centered */
            gap: 8px;
        }

        .dashboard-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: 0.2s;
        }

        .dashboard-card:hover {
            background: var(--bg-sidebar);
        }

        .dashboard-card.overdue {
            border-left: 4px solid #d32f2f;
            background: rgba(244, 67, 54, 0.05);
        }

        body.dark-mode .dashboard-card.overdue {
            background: rgba(244, 67, 54, 0.1);
        }

        .dashboard-card .card-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 5px;
        }

        .dashboard-card .card-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        /* Dropdown Menu */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 5px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            min-width: 160px;
            margin-top: 5px;
        }

        .dropdown-menu.show {
            display: block;
            animation: fadeIn 0.1s ease;
        }

        .dropdown-menu div {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            transition: background 0.2s;
        }

        .dropdown-menu div:hover {
            background: var(--bg-app);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="app-container">
        <!-- SIDEBAR NAVIGATION -->
        <aside class="sidebar">
            <button class="nav-btn active" onclick="switchView('dashboard')" title="Dashboard">
                <!-- HOME ICON -->
                <svg viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                </svg>
            </button>
            <button class="nav-btn" onclick="switchView('checklist')" title="Mi Agenda">
                <!-- LIST/AGENDA ICON -->
                <svg viewBox="0 0 24 24">
                    <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" />
                </svg>
            </button>
            <button class="nav-btn" onclick="switchView('calendar')" title="Calendario">
                <!-- CALENDAR ICON -->
                <svg viewBox="0 0 24 24">
                    <path
                        d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" />
                </svg>
            </button>
            <button class="nav-btn" onclick="switchView('settings')" title="Configuraci√≥n">
                <!-- SETTINGS/GEAR ICON -->
                <svg viewBox="0 0 24 24">
                    <path
                        d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23-.41-.12-.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
                </svg>
            </button>
        </aside>

        <!-- MAIN AREA -->
        <main class="main-content">
            <!-- TOP BAR -->
            <!-- TOP BAR -->
            <div class="top-bar">
                <h2 id="page-title">Dashboard</h2>

                <div class="controls">
                    <!-- Date Controls (Simplified) -->
                    <div id="date-controls" style="display:none; gap:10px;">
                        <select id="mes" style="width: auto; padding: 6px 10px;"></select>
                        <select id="anio" style="width: auto; padding: 6px 10px;"></select>
                    </div>

                    <!-- Filter Toggle Button (For Checklist) -->
                    <button id="filter-toggle-btn" onclick="toggleFilterOverlay()" class="btn-toggle"
                        style="display:none; background:transparent; color:var(--text-primary); padding: 8px;">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z" />
                        </svg>
                    </button>

                    <!-- Add Button -->
                    <div style="position:relative;">
                        <button onclick="toggleAddMenu()" class="btn-toggle"
                            style="background:var(--accent); color:white; display:flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius: 50%; padding:0;">
                            <span style="font-size:20px; line-height:1;">+</span>
                        </button>
                        <div id="add-menu" class="dropdown-menu" style="right:0; width:180px;">
                            <div onclick="openEditModal(); toggleAddMenu();">Nuevo Pago</div>
                            <div onclick="openNoteModal(); toggleAddMenu();">Nueva Actividad</div>
                        </div>
                    </div>
                </div>

                <!-- FILTER OVERLAY -->
                <div id="filter-overlay">
                    <label style="font-size:12px; color:var(--text-secondary); margin-bottom:-5px;">Mostrar:</label>
                    <select id="filter-type">
                        <option value="all">Todo</option>
                        <option value="pagos">Pagos</option>
                        <option value="citas">Citas</option>
                        <option value="completado">Completado</option>
                        <option value="pendiente" selected>Pendiente</option>
                    </select>

                    <label style="font-size:12px; color:var(--text-secondary); margin-bottom:-5px;">Concepto:</label>
                    <select id="filter-concept">
                        <option value="all">Concepto: Todos</option>
                    </select>

                    <button onclick="toggleFilterOverlay()"
                        style="background:var(--accent); color:white; border:none; padding:10px; border-radius:8px; margin-top:5px;">Aplicar
                        Filtros</button>
                </div>

            </div>

            <!-- VIEW: DASHBOARD -->
            <div id="dashboard" class="view-section active">
                <div class="dashboard-container">
                    <div class="db-header-card">
                        <div>
                            <h2 id="welcome-message" style="margin:0; font-size:24px;">Hola!</h2>
                            <span style="opacity:0.8; font-size:14px;">Total del mes</span>
                        </div>
                        <div class="db-stat">
                            <div class="label">Pendiente</div>
                            <div class="value" id="db-total-pending">$0</div>
                        </div>
                    </div>

                    <div class="dashboard-section" id="section-overdue" style="display:none;">
                        <h3>Pagos Vencidos</h3>
                        <div id="overdue-list"></div>
                    </div>

                    <div class="dashboard-section">
                        <h3>Pr√≥ximos 7 D√≠as</h3>
                        <div id="upcoming-list"></div>
                    </div>

                    <div class="dashboard-section">
                        <h3>Resumen Mensual</h3>
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span>Pagado</span>
                            <strong style="color:var(--status-paid-text)" id="db-total-paid">$0</strong>
                        </div>
                        <div
                            style="width:100%; background:var(--bg-app); height:8px; border-radius:4px; overflow:hidden;">
                            <div id="db-progress-bar"
                                style="width:0%; background:var(--accent); height:100%; transition:width 0.5s;"></div>
                        </div>
                        <small style="display:block; margin-top:5px; color:var(--text-secondary); text-align:right;"
                            id="db-progress-text">0% Completado</small>
                    </div>
                </div>
            </div>

            <!-- VIEW: LISTA DE PAGOS / CHECKLIST -->
            <div id="checklist" class="view-section">
                <!-- Action Buttons -->
                <!-- Action Buttons: Moved to Top Bar -->
                <div style="margin-bottom:20px;"></div>

                <div class="row" style="display:flex; flex-wrap:wrap; gap:20px;">
                    <!-- COL 1: PAGOS -->
                    <div style="flex:1; min-width:300px;">
                        <div class="checklist-container" id="listaPagosContainer">
                            <h3 class="checklist-header">
                                <span data-i18n="pending_payments">Pagos Pendientes</span>
                            </h3>
                            <div id="listaPagos"></div>
                        </div>
                    </div>

                    <!-- COL 2: AGENDA/TAREAS -->
                    <div style="flex:1; min-width:300px;">
                        <div class="checklist-container" id="listaTareasContainer">
                            <h3 class="checklist-header">
                                <span data-i18n="todo_list">Por Hacer / Citas</span>
                            </h3>
                            <div id="listaTareas"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: CALENDAR -->
            <div id="calendar" class="view-section">
                <div class="calendar-wrapper">
                    <div class="calendar" id="calendar-grid">
                        <!-- Calendar injected by JS -->
                    </div>
                </div>
            </div>

            <!-- VIEW: AGENDA (Removed as per instruction to merge with checklist) -->
            <!-- The content of the original agenda view is now handled by openNoteModal() -->

            <!-- VIEW: SETTINGS -->
            <div id="settings" class="view-section">
                <div class="settings-container">
                    <h3 data-i18n="settings">Configuraci√≥n</h3>

                    <div class="setting-item">
                        <span>Nombre de Usuario</span>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="username-input" class="agenda-input" placeholder="Tu Nombre"
                                style="width:150px;" onchange="saveUsername(this.value)">
                        </div>
                    </div>

                    <div class="setting-item">
                        <span data-i18n="language">Idioma</span>
                        <select id="lang-select" onchange="changeLanguage(this.value)" style="width: auto;">
                            <option value="es">Espa√±ol</option>
                            <option value="en">English</option>
                        </select>
                    </div>

                    <div class="setting-item">
                        <span data-i18n="dark_mode">Modo Oscuro</span>
                        <button class="btn-toggle" id="theme-toggle" onclick="toggleTheme()">Activar</button>
                    </div>
                </div>

                <div class="settings-container" style="margin-top: 20px;">
                    <h3>Gesti√≥n de Datos</h3>

                    <div class="setting-item">
                        <span>Conceptos de Pago</span>
                        <button class="btn-toggle" onclick="openConceptManager()">Gestionar</button>
                    </div>

                    <div class="setting-item">
                        <span>Copia de Seguridad</span>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-toggle" onclick="exportData()"
                                title="Descargar archivo JSON">Exportar</button>
                            <label class="btn-toggle" style="cursor:pointer; position:relative;"
                                title="Cargar archivo JSON">
                                Importar
                                <input type="file" id="import-file" onchange="importData(this)"
                                    style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;"
                                    accept=".json">
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: CONCEPT MANAGER (Hidden initially) -->
            <div id="concept-manager" class="view-section">
                <div class="top-bar">
                    <button onclick="closeConceptManager()"
                        style="background:none; border:none; color:var(--text-primary); font-size:24px; cursor:pointer;">‚Üê</button>
                    <h2>Conceptos de Pago</h2>
                    <button onclick="openEditModal()"
                        style="background:var(--accent); color:white; border:none; width:36px; height:36px; border-radius:50%; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center;">+</button>
                </div>
                <div class="checklist-container" id="concepts-list" style="padding-top:20px;">
                    <!-- Concepts injected by JS -->
                </div>
            </div>

            <!-- MODAL: EDIT CONCEPT -->
            <div id="edit-modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
                <div
                    style="background:var(--bg-panel); padding:20px; border-radius:12px; width:90%; max-width:400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid var(--border-color);">
                    <h3 style="margin-top:0; color:var(--text-primary);">Editar Concepto</h3>

                    <input type="hidden" id="edit-id">

                    <div style="margin-bottom:15px;">
                        <label
                            style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">Nombre</label>
                        <input type="text" id="edit-nombre" class="agenda-input" style="width:100%;"
                            placeholder="Ej. Netflix">
                    </div>

                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <div style="flex:1;">
                            <label
                                style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">D√≠a
                                Inicio</label>
                            <input type="number" id="edit-inicio" class="agenda-input" style="width:100%;" min="1"
                                max="31">
                        </div>
                        <div style="flex:1;">
                            <label
                                style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">D√≠a
                                Fin</label>
                            <input type="number" id="edit-fin" class="agenda-input" style="width:100%;" min="1"
                                max="31">
                        </div>
                    </div>

                    <div style="margin-bottom:15px; display:flex; gap:15px; align-items:center;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                            <input type="checkbox" id="edit-finMes"
                                style="width:18px; height:18px; accent-color:var(--accent);">
                            <span style="color:var(--text-primary); font-size:14px;">Pagar a Fin de Mes</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                            <input type="checkbox" id="edit-mandatory"
                                style="width:18px; height:18px; accent-color:#e74c3c;">
                            <span style="color:var(--text-primary); font-size:14px;">Obligatorio</span>
                        </label>
                    </div>

                    <div style="margin-bottom:15px;">
                        <label
                            style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">Prioridad</label>
                        <select id="edit-priority" class="agenda-input" style="width:100%;">
                            <option value="1">üî¥ Alta (Inmediato)</option>
                            <option value="2">üü† Media (Preventivo)</option>
                            <option value="3" selected>üü° Baja (Opcional)</option>
                        </select>
                    </div>

                    <hr style="border:0; border-top:1px solid var(--border-color); margin:15px 0;">

                    <div style="margin-bottom:15px;">
                        <label
                            style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">V√°lido
                            Desde (Mes/A√±o)</label>
                        <input type="month" id="edit-validFrom" class="agenda-input" style="width:100%;">
                    </div>

                    <div style="margin-bottom:20px;">
                        <label
                            style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">V√°lido
                            Hasta (Opcional)</label>
                        <input type="month" id="edit-validUntil" class="agenda-input" style="width:100%;">
                    </div>

                    <div style="display:flex; justify-content:flex-end; gap:10px;">
                        <button onclick="closeEditModal()" class="btn-toggle"
                            style="background:transparent; color:var(--text-secondary); border:1px solid var(--border-color);">Cancelar</button>
                        <button onclick="saveConcept()" class="btn-toggle"
                            style="background:var(--accent); color:white;">Guardar</button>
                        <button onclick="deleteConcept()" id="btn-delete-concept" class="btn-toggle"
                            style="background:#ef5350; color:white; margin-right:auto;">Eliminar</button>
                    </div>
                </div>
            </div>

            <!-- MODAL: NOTE / ACTIVITY -->
            <div id="note-modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
                <div
                    style="background:var(--bg-panel); padding:20px; border-radius:12px; width:90%; max-width:400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid var(--border-color);">
                    <h3 style="margin-top:0; color:var(--text-primary);">Editar Actividad</h3>

                    <input type="hidden" id="note-id">

                    <div style="margin-bottom:15px;">
                        <label
                            style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">Actividad</label>
                        <input type="text" id="note-input" class="agenda-input" style="width:100%;"
                            placeholder="Ej. Cancelar suscripci√≥n">
                    </div>

                    <div style="margin-bottom:15px;">
                        <label
                            style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">Descripci√≥n
                            (Opcional)</label>
                        <textarea id="note-desc" class="agenda-input" style="width:100%; height:60px; resize:none;"
                            placeholder="Detalles..."></textarea>
                    </div>

                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <div style="flex:1;">
                            <label
                                style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">Fecha</label>
                            <input type="date" id="note-date" class="agenda-input" style="width:100%;">
                        </div>
                        <div style="flex:1;">
                            <label
                                style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">Hora
                                (Opcional)</label>
                            <input type="time" id="note-time" class="agenda-input" style="width:100%;">
                        </div>
                    </div>

                    <div style="margin-bottom:15px;">
                        <label
                            style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">Prioridad</label>
                        <select id="note-priority" class="agenda-input" style="width:100%;">
                            <option value="1">üî¥ Alta</option>
                            <option value="2">üü† Media</option>
                            <option value="3" selected>üü° Baja</option>
                        </select>
                    </div>

                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                        <button onclick="closeNoteModal()" class="btn-toggle"
                            style="background:transparent; color:var(--text-secondary); border:1px solid var(--border-color);">Cancelar</button>
                        <button onclick="saveNote()" class="btn-toggle"
                            style="background:var(--accent); color:white;">Guardar</button>
                        <button onclick="deleteNoteFromModal()" id="btn-delete-note" class="btn-toggle"
                            style="background:#ef5350; color:white; margin-right:auto; display:none;">Eliminar</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        /* --- DATA --- */
        const defaultPagos = [
            { nombre: "BBVA Tarjeta Cr√©dito", inicio: 1, fin: 15 },
            { nombre: "RappiCard", inicio: 1, fin: 9 },
            { nombre: "Seguro Vehicular", inicio: 10, fin: 15 },
            { nombre: "Ahorro Viajes", inicio: 15, finMes: true },
            { nombre: "Pr√©stamo Maylin", inicio: 10, fin: 15 },
            { nombre: "Pr√©stamo BBVA", inicio: 1, fin: 10 },
            { nombre: "Agua", inicio: 20, finMes: true },
            { nombre: "Luz", inicio: 20, fin: 26 },
            { nombre: "Gas", inicio: 1, fin: 15 },
            { nombre: "Claro Hogar", inicio: 3, fin: 18 },
            { nombre: "Administraci√≥n", inicio: 1, fin: 5 },
            { nombre: "Claro M√≥vil", inicio: 3, fin: 15 },
            { nombre: "Universidad", inicio: 1, fin: 5 } // Added by request
        ];

        const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        /* --- DOM ELEMENTS --- */
        const mesSel = document.getElementById("mes");
        const anioSel = document.getElementById("anio");
        const calGrid = document.getElementById("calendar-grid");
        const listaPagos = document.getElementById("listaPagos");
        const pageTitle = document.getElementById("page-title");
        const dateControls = document.getElementById("date-controls");

        /* --- INITIALIZATION & TRANSLATIONS --- */
        for (let i = 0; i < 12; i++) mesSel.innerHTML += `<option value="${i}">${meses[i]}</option>`;

        /* --- TRANSLATIONS --- */
        const translations = {
            es: {
                home: "Inicio",
                checklist: "Agenda",
                calendar: "Calendario",
                agenda: "Notas",
                settings: "Configuraci√≥n",
                pending_payments: "Pagos Pendientes",
                todo_list: "Por Hacer / Citas",
                language: "Idioma",
                dark_mode: "Modo Oscuro",
                overdue_title: "‚ö†Ô∏è Pagos Vencidos",
                upcoming_7_days: "üìÖ Pr√≥ximos 7 D√≠as",
                monthly_summary: "üìä Resumen Mensual",
                paid: "Pagado",
                completed: "Completado",
                days_late: "d√≠as de retraso",
                vencido_hace: "Vencido hace",
                pending_count: "Pendiente",
                no_upcoming: "No hay eventos pr√≥ximos",
                all_up_to_date: "¬°Todo al d√≠a!",
                delete_note_confirm: "¬øBorrar nota?",
                delete_concept_confirm: "¬øEliminar este concepto? Se perder√° el historial asociado."
            },
            en: {
                home: "Home",
                checklist: "Checklist",
                calendar: "Calendar",
                agenda: "Agenda",
                settings: "Settings",
                pending_payments: "Pending Payments",
                todo_list: "To-Do / Appointments",
                language: "Language",
                dark_mode: "Dark Mode",
                overdue_title: "‚ö†Ô∏è Overdue Payments",
                upcoming_7_days: "üìÖ Next 7 Days",
                monthly_summary: "üìä Monthly Summary",
                paid: "Paid",
                completed: "Completed",
                days_late: "days late",
                vencido_hace: "Overdue by",
                pending_count: "Pending",
                no_upcoming: "No upcoming events",
                all_up_to_date: "All caught up!",
                delete_note_confirm: "Delete note?",
                delete_concept_confirm: "Delete this concept? Associated history will be lost."
            }
        };

        function getUsername() { return localStorage.getItem('username') || 'Usuario'; }
        function saveUsername(name) {
            if (!name.trim()) return;
            localStorage.setItem('username', name.trim());
            updateTexts();
            const elWelcome = document.getElementById('welcome-message');
            if (elWelcome) elWelcome.textContent = `Hola, ${name.trim()}! üëã`;
        }

        function getLang() { return localStorage.getItem('lang') || 'es'; }
        function t(key) { return translations[getLang()][key] || key; }

        function changeLanguage(lang) {
            localStorage.setItem('lang', lang);
            updateTexts();
            const view = document.querySelector('.view-section.active');
            if (view) switchView(view.id);
        }

        function updateTexts() {
            const lang = getLang();
            const sel = document.getElementById('lang-select');
            if (sel) sel.value = lang;

            const navBtns = document.querySelectorAll('.nav-btn label');
            if (navBtns.length >= 5) {
                navBtns[0].textContent = t('home');
                navBtns[1].textContent = t('checklist');
                navBtns[2].textContent = t('calendar');
                navBtns[3].textContent = t('agenda');
                navBtns[4].textContent = t('settings');
            }

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });

            // Dynamic headers
            const overdueTitle = document.querySelector('#section-overdue h3');
            if (overdueTitle) overdueTitle.textContent = t('overdue_title');
            const sections = document.querySelectorAll('.dashboard-section h3');
            sections.forEach(h3 => {
                if (h3.textContent.includes('D√≠as')) h3.textContent = t('upcoming_7_days');
                if (h3.textContent.includes('Resumen')) h3.textContent = t('monthly_summary');
            });
        }

        // YEAR LOGIC
        function detectActiveYears() {
            let minYear = 2026;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.match(/^(\d{4})-\d{1,2}$/)) {
                    const y = parseInt(key.split('-')[0]);
                    if (y < minYear) minYear = y;
                }
            }
            return minYear;
        }

        const startYear = detectActiveYears();
        for (let y = startYear; y <= 2035; y++) anioSel.innerHTML += `<option value="${y}">${y}</option>`;




        const hoy = new Date();
        mesSel.value = hoy.getMonth();
        anioSel.value = hoy.getFullYear();

        /* --- THEME LOGIC --- */
        const themeToggleBtn = document.getElementById("theme-toggle");

        function initTheme() {
            const isDark = localStorage.getItem('theme') === 'dark';
            if (isDark) {
                document.body.classList.add('dark-mode');
                themeToggleBtn.textContent = "Desactivar";
                themeToggleBtn.classList.add('active');
            }
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            themeToggleBtn.textContent = isDark ? "Desactivar" : "Activar";
            themeToggleBtn.classList.toggle('active');
        }

        /* --- NAVIGATION LOGIC --- */
        function switchView(viewName) {
            // Hide all views: remove active class AND clear specific display overrides
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                el.style.display = ''; // Clear inline display styles (fixes locked views)
            });
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            // Show selected
            document.getElementById(viewName).classList.add('active');

            // Update Nav
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.nav-btn[onclick="switchView('${viewName}')"]`);
            if (activeBtn) activeBtn.classList.add('active');

            // Header Elements Logic
            const pageTitle = document.getElementById('page-title');
            const dateControls = document.getElementById('date-controls');
            const filterToggleBtn = document.getElementById('filter-toggle-btn');
            const filterOverlay = document.getElementById('filter-overlay');

            // Close overlay when switching
            if (filterOverlay) {
                filterOverlay.style.display = 'none';
                filterOverlay.classList.remove('open');
            }

            if (viewName === 'dashboard') {
                pageTitle.innerText = t('home');
                dateControls.style.display = 'none';
                if (filterToggleBtn) filterToggleBtn.style.display = 'none';
                renderDashboard();
            } else if (viewName === 'checklist') {
                pageTitle.innerText = t('view_checklist') || "Mi Agenda";
                dateControls.style.display = 'none';
                if (filterToggleBtn) filterToggleBtn.style.display = 'block'; // Show Filter Toggle
                cargar(); // Refresh list with current filters
            } else if (viewName === 'calendar') {
                pageTitle.innerText = t('view_calendar') || "Calendario";
                dateControls.style.display = 'flex';
                if (filterToggleBtn) filterToggleBtn.style.display = 'none';
                cargar();
            } else if (viewName === 'agenda') { // Original agenda view
                pageTitle.textContent = t('agenda');
                dateControls.style.display = 'none';
                if (filterToggleBtn) filterToggleBtn.style.display = 'none';
                renderAgenda();
            } else { // Settings view
                pageTitle.innerText = t('view_settings') || "Configuraci√≥n";
                dateControls.style.display = 'none';
                if (filterToggleBtn) filterToggleBtn.style.display = 'none';
                const uInput = document.getElementById('username-input');
                if (uInput) uInput.value = getUsername();
            }
        }

        function toggleAddMenu() {
            const menu = document.getElementById('add-menu');
            if (menu.style.display === 'block') {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'block';
            }
        }

        function toggleFilterOverlay() {
            const overlay = document.getElementById('filter-overlay');
            if (overlay.style.display === 'flex') {
                overlay.style.display = 'none';
                overlay.classList.remove('open');
            } else {
                overlay.style.display = 'flex';
                setTimeout(() => overlay.classList.add('open'), 10); // Trigger anim
            }
            // Add listener to close if clicking outside? Maybe later.
        }

        /* --- PAYMENT CONCEPTS MANAGEMENT --- */
        function getConcepts() {
            let concepts = [];
            try {
                const raw = localStorage.getItem("concepts");
                if (raw) concepts = JSON.parse(raw);
            } catch (e) {
                console.error("Error parsing concepts", e);
                concepts = [];
            }

            if (!concepts || !Array.isArray(concepts) || concepts.length === 0) {
                // First run: Initialize all defaults
                concepts = defaultPagos.map((p, idx) => ({
                    ...p,
                    id: Date.now() + idx,
                    validFrom: "2024-01",
                    validUntil: null,
                    priority: "3",
                    mandatory: false
                }));
                localStorage.setItem("concepts", JSON.stringify(concepts));
            } else {
                // Sync Check and Migration
                let changed = false;

                // Filter out nulls
                concepts = concepts.filter(c => c);

                // MIGRATION: Backfill missing properties
                concepts.forEach(c => {
                    if (!c.validFrom) { c.validFrom = "2024-01"; changed = true; }
                    if (!c.id) { c.id = Date.now() + Math.floor(Math.random() * 100000); changed = true; }
                    if (!c.priority) { c.priority = "3"; changed = true; }
                    if (c.mandatory === undefined) { c.mandatory = false; changed = true; }
                });

                // Check for new defaults
                defaultPagos.forEach(def => {
                    const exists = concepts.some(c => c.nombre === def.nombre);
                    if (!exists) {
                        concepts.push({
                            ...def,
                            id: Date.now() + Math.floor(Math.random() * 1000),
                            validFrom: new Date().toISOString().slice(0, 7),
                            validUntil: null,
                            priority: "3",
                            mandatory: false
                        });
                        changed = true;
                    }
                });

                if (changed) saveConcepts(concepts);
            }
            return concepts;
        }

        function saveConcepts(concepts) {
            localStorage.setItem("concepts", JSON.stringify(concepts));
            populateConceptFilter();
        }

        function openConceptManager() {
            document.getElementById('settings').style.display = 'none';
            document.getElementById('concept-manager').style.display = 'block';
            document.getElementById('concept-manager').classList.add('active');
            renderConceptsList();
        }

        function closeConceptManager() {
            document.getElementById('concept-manager').style.display = 'none';
            document.getElementById('concept-manager').classList.remove('active');
            document.getElementById('settings').style.display = 'block';
            document.getElementById('settings').classList.add('active');
            cargar(); // Refresh main views with potential changes
        }

        function renderConceptsList() {
            const list = document.getElementById("listaPagos");
            if (!list) return;
            list.innerHTML = "";
            const concepts = getConcepts();

            if (concepts.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-secondary)">No hay conceptos.</div>`;
                return;
            }

            concepts.forEach(c => {
                const div = document.createElement("div");
                div.className = "item";
                div.style.cursor = "pointer";
                div.onclick = (e) => {
                    // Prevent triggering if clicking something else inside (if exists)
                    openEditModal(c.id);
                };

                let periodText = `<small style="display:block; color:var(--text-secondary); font-size:11px;">Desde: ${c.validFrom}`;
                if (c.validUntil) periodText += ` ¬∑ Hasta: ${c.validUntil}`;
                else periodText += ` ¬∑ Indefinido`;
                periodText += `</small>`;

                let priorityIndicator = "";
                // if (c.priority == "1") priorityIndicator = `<span style="color:#e74c3c; margin-right:5px;">üî¥</span>`;
                // else if (c.priority == "2") priorityIndicator = `<span style="color:#f39c12; margin-right:5px;">üü†</span>`;

                div.innerHTML = `
                    <div style="flex:1;">
                        <span style="font-weight:500">${c.nombre} ${c.mandatory ? '<span style="color:#c0392b; font-size:11px; border:1px solid #c0392b; padding:1px 4px; border-radius:4px;">Obligatorio</span>' : ''}</span>
                        ${periodText}
                    </div>
                    <span style="font-size:12px; color:var(--text-secondary)">D√≠a ${c.inicio}</span>
                `;
                list.appendChild(div);
            });
        }

        function openEditModal(id = null) {
            const modal = document.getElementById("edit-modal");
            const concepts = getConcepts();

            document.getElementById("edit-id").value = id || "";

            if (id) {
                const c = concepts.find(x => x.id == id);
                if (c) {
                    document.getElementById("edit-nombre").value = c.nombre;
                    document.getElementById("edit-inicio").value = c.inicio;
                    document.getElementById("edit-fin").value = c.fin || "";
                    document.getElementById("edit-finMes").checked = !!c.finMes;
                    document.getElementById("edit-validFrom").value = c.validFrom || "";
                    document.getElementById("edit-validUntil").value = c.validUntil || "";
                    document.getElementById("btn-delete-concept").style.display = "block";
                }
            } else {
                // New
                document.getElementById("edit-nombre").value = "";
                document.getElementById("edit-inicio").value = "1";
                document.getElementById("edit-fin").value = "";
                document.getElementById("edit-finMes").checked = false;

                // Set default "From" to current month
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                document.getElementById("edit-validFrom").value = currentMonth;
                document.getElementById("edit-validUntil").value = "";

                document.getElementById("btn-delete-concept").style.display = "none";
            }

            // Set fields if new or existing
            if (id) {
                const c = concepts.find(x => x.id == id);
                if (c) {
                    document.getElementById("edit-mandatory").checked = !!c.mandatory;
                    document.getElementById("edit-priority").value = c.priority || "3";
                }
            } else {
                document.getElementById("edit-mandatory").checked = false;
                document.getElementById("edit-priority").value = "3";
            }

            modal.style.display = "flex";
        }

        function closeEditModal() {
            document.getElementById("edit-modal").style.display = "none";
        }

        function saveConcept() {
            const id = document.getElementById("edit-id").value;
            const nombre = document.getElementById("edit-nombre").value.trim();
            const inicio = parseInt(document.getElementById("edit-inicio").value);
            const finStr = document.getElementById("edit-fin").value;
            const fin = finStr ? parseInt(finStr) : null;
            const finMes = document.getElementById("edit-finMes").checked;
            const mandatory = document.getElementById("edit-mandatory").checked;
            const priority = document.getElementById("edit-priority").value;
            const validFrom = document.getElementById("edit-validFrom").value;
            const validUntil = document.getElementById("edit-validUntil").value || null;

            if (!nombre || !inicio || !validFrom) {
                alert("Nombre, D√≠a de Inicio y Fecha de Validez son obligatorios.");
                return;
            }

            let concepts = getConcepts();

            const newConcept = {
                id: id ? parseInt(id) : Date.now(),
                nombre,
                inicio,
                fin: fin || (finMes ? null : inicio),
                finMes,
                mandatory,
                priority,
                validFrom,
                validUntil
            };

            if (id) {
                const idx = concepts.findIndex(c => c.id == id);
                if (idx !== -1) concepts[idx] = newConcept;
            } else {
                concepts.push(newConcept);
            }

            saveConcepts(concepts);
            closeEditModal();
            renderConceptsList();
        }

        function deleteConcept() {
            const id = document.getElementById("edit-id").value;
            if (!id) return;

            if (!confirm("¬øEliminar este concepto? Se perder√° el historial asociado si se borra.")) return;

            let concepts = getConcepts();
            concepts = concepts.filter(c => c.id != id);
            saveConcepts(concepts);
            closeEditModal();
            renderConceptsList();
        }

        /* --- IMPORT / EXPORT DATA --- */
        function exportData() {
            const concepts = getConcepts();
            const agenda = getAgenda();

            // Get all payment status keys
            const paymentHistory = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // keys like '2024-5', '2024-11' etc.
                if (key.match(/^\d{4}-\d{1,2}$/)) {
                    paymentHistory[key] = JSON.parse(localStorage.getItem(key));
                }
            }

            const data = {
                concepts,
                agenda,
                paymentHistory,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `backup_control_pagos_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (confirm("Al importar se reemplazar√°n los datos actuales. ¬øDeseas continuar?")) {
                        // Clear current data? Maybe selective overwrite is safer.
                        // Let's overwrite known keys.

                        if (data.concepts) localStorage.setItem("concepts", JSON.stringify(data.concepts));
                        if (data.agenda) localStorage.setItem("agenda", JSON.stringify(data.agenda));

                        if (data.paymentHistory) {
                            // Clear old payment history keys first?? No, let's just merge/overwrite.
                            Object.keys(data.paymentHistory).forEach(key => {
                                localStorage.setItem(key, JSON.stringify(data.paymentHistory[key]));
                            });
                        }

                        alert("Datos importados correctamente.");
                        location.reload(); // Reload to refresh everything
                    }
                } catch (err) {
                    alert("Error al leer el archivo: " + err);
                }
            };
            reader.readAsText(file);
            // Reset input so same file can be selected again if needed
            input.value = '';
        }

        /* --- AGENDA LOGIC --- */
        const agendaList = document.getElementById("listaTareas");

        function getAgenda() {
            return JSON.parse(localStorage.getItem("agenda")) || [];
        }

        function saveAgenda(data) {
            localStorage.setItem("agenda", JSON.stringify(data));
        }

        function openNoteModal(id = null) {
            const modal = document.getElementById("note-modal");
            const btnDelete = document.getElementById("btn-delete-note");

            document.getElementById("note-id").value = id || "";

            if (id) {
                const notes = getAgenda();
                const note = notes.find(n => n.id == id);
                if (note) {
                    document.getElementById("note-input").value = note.text;
                    document.getElementById("note-desc").value = note.desc || "";
                    document.getElementById("note-date").value = note.date || "";
                    document.getElementById("note-time").value = note.time || "";
                    document.getElementById("note-priority").value = note.priority || "3";
                    btnDelete.style.display = "block";
                    // We set the onclick dynamically or use the ID in the simplified helper
                }
            } else {
                // New
                document.getElementById("note-input").value = "";
                document.getElementById("note-desc").value = "";

                // Default date to today
                const now = new Date();
                const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                document.getElementById("note-date").value = today;

                document.getElementById("note-time").value = "";
                document.getElementById("note-priority").value = "3";
                btnDelete.style.display = "none";
            }

            modal.style.display = "flex";
            document.getElementById("note-input").focus();
        }

        function closeNoteModal() {
            document.getElementById("note-modal").style.display = "none";
        }

        function saveNote() {
            const id = document.getElementById("note-id").value;
            const text = document.getElementById("note-input").value.trim();
            const desc = document.getElementById("note-desc").value.trim();
            const date = document.getElementById("note-date").value;
            const time = document.getElementById("note-time").value;
            const priority = document.getElementById("note-priority").value;

            if (!text) {
                alert("La actividad debe tener un nombre.");
                return;
            }

            const notes = getAgenda();

            if (id) {
                const index = notes.findIndex(n => n.id == id);
                if (index !== -1) {
                    notes[index] = { ...notes[index], text, desc, date, time, priority };
                }
            } else {
                const newNote = {
                    id: Date.now(),
                    text, desc,
                    date: date || null,
                    time: time || null,
                    priority: priority || "3",
                    completed: false,
                    skipped: false,
                    created: new Date().toLocaleDateString()
                };
                notes.unshift(newNote);
            }

            saveAgenda(notes);
            closeNoteModal();
            renderAgenda();
            cargar();
            renderDashboard();
        }

        function editNote(id) {
            openNoteModal(id);
        }

        function deleteNote(id) {
            if (!confirm(t('delete_note_confirm') || "¬øBorrar nota?")) return;
            const notes = getAgenda().filter(n => n.id != id);
            saveAgenda(notes);
            closeNoteModal();
            renderAgenda();
            cargar();
            renderDashboard();
        }

        function deleteNoteFromModal() {
            const id = document.getElementById("note-id").value;
            if (id) deleteNote(id);
        }




        function renderAgenda() {
            const notes = getAgenda();
            if (!agendaList) return; // Guard clause

            agendaList.innerHTML = "";

            if (notes.length === 0) {
                agendaList.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-secondary)">${t('pending_count') || 'Pendiente'}... 0</div>`;
                return;
            }

            notes.forEach(n => {
                const displayDate = n.date ? new Date(n.date).toLocaleDateString() : n.created;
                const displayTime = n.time ? ` ‚Ä¢ ${n.time}` : "";
                const descHtml = n.desc ? `<div style="margin-top:5px; font-size:13px; color:var(--text-secondary); white-space:pre-wrap;">${n.desc}</div>` : '';

                // Priority Styles
                let borderColor = "var(--border-color)";
                // let priorityIcon = "";
                if (n.priority == "1") { borderColor = "#e74c3c"; }
                else if (n.priority == "2") { borderColor = "#f39c12"; }

                // Skipped Style
                const isSkipped = n.skipped === true;
                const opacity = isSkipped ? "0.5" : "1";
                const textDeco = isSkipped ? "line-through" : "none";

                agendaList.innerHTML += `
                    <div class="note-card" style="border-left: 4px solid ${borderColor}; opacity: ${opacity};">
                        <div class="note-header">
                            <span>${displayDate}${displayTime}</span>
                            <div>
                                <button class="btn-delete-note" onclick="editNote(${n.id})" style="color:var(--accent); font-size:18px; margin-right:5px;">‚úé</button>
                                <button class="btn-delete-note" onclick="deleteNote(${n.id})">√ó</button>
                            </div>
                        </div>
                        <div class="note-body" style="font-weight:500; text-decoration:${textDeco};">${n.text}</div>
                        ${descHtml}
                        <div style="margin-top:10px; padding-top:10px; border-top:1px solid #eee; display:flex; align-items:center; gap:10px;">
                             <label style="font-size:12px; display:flex; align-items:center; gap:5px; cursor:pointer;">
                                <input type="checkbox" onchange="toggleSkipped(${n.id}, this.checked)" ${isSkipped ? 'checked' : ''}>
                                No realic√© esta actividad
                             </label>
                        </div>
                    </div>
                `;
            });
        }

        function toggleSkipped(id, val) {
            const notes = getAgenda();
            const idx = notes.findIndex(n => n.id == id);
            if (idx !== -1) {
                notes[idx].skipped = val;
                saveAgenda(notes);
                renderAgenda();
                cargar();
            }
        }

        /* --- DASHBOARD RENDERING --- */
        /* --- DASHBOARD RENDERING --- */
        function renderDashboard() {
            const overdueList = document.getElementById('overdue-list');
            const upcomingList = document.getElementById('upcoming-list');
            const sectionOverdue = document.getElementById('section-overdue');

            const elTotalPending = document.getElementById('db-total-pending');
            const elTotalPaid = document.getElementById('db-total-paid');
            const elProgressBar = document.getElementById('db-progress-bar');
            const elProgressText = document.getElementById('db-progress-text');

            // Update Welcome Message
            const elWelcome = document.getElementById('welcome-message');
            if (elWelcome) elWelcome.textContent = `Hola, ${getUsername()}!`;

            if (overdueList) overdueList.innerHTML = '';
            if (upcomingList) upcomingList.innerHTML = '';

            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            const currentMonthStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

            let countPending = 0;
            let countPaid = 0;
            const concepts = getConcepts();
            const currentKey = `${currentYear}-${currentMonth}`;
            const currentData = JSON.parse(localStorage.getItem(currentKey)) || {};

            // 1. Summary Stats
            concepts.forEach(c => {
                if (c.validFrom <= currentMonthStr && (!c.validUntil || c.validUntil >= currentMonthStr)) {
                    const isPaid = currentData[c.id] === true;
                    if (isPaid) countPaid++; else countPending++;
                }
            });
            const totalItems = countPaid + countPending;
            const percentage = totalItems === 0 ? 0 : Math.round((countPaid / totalItems) * 100);

            elTotalPending.textContent = countPending;
            elTotalPaid.textContent = countPaid;
            elProgressBar.style.width = `${percentage}%`;
            elProgressText.textContent = `${percentage}% ${t('completed')} (${countPaid}/${totalItems})`;

            // 2. Overdue Logic (Grouped)
            let scanStartYear = detectActiveYears();
            const rawOverdue = [];
            for (let year = scanStartYear; year <= currentYear; year++) {
                const endMonth = (year === currentYear) ? currentMonth : 11;
                for (let month = 0; month <= endMonth; month++) {
                    if (year === currentYear && month >= currentMonth) continue;
                    const key = `${year}-${month}`;
                    let data = JSON.parse(localStorage.getItem(key)) || {};
                    const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;

                    concepts.forEach(concept => {
                        if (concept.validFrom <= monthStr && (!concept.validUntil || concept.validUntil >= monthStr)) {
                            const isPaid = data[concept.id] === true;
                            if (!isPaid) {
                                rawOverdue.push({
                                    name: concept.nombre,
                                    dueDate: new Date(year, month, +concept.inicio),
                                    month: month + 1, year
                                });
                            }
                        }
                    });
                }
            }

            // Grouping
            const grouped = {};
            rawOverdue.forEach(o => {
                if (!grouped[o.name]) grouped[o.name] = { ...o, count: 0 };
                // Keep oldest date
                if (o.dueDate < grouped[o.name].dueDate) grouped[o.name].dueDate = o.dueDate;
                grouped[o.name].count++;
            });

            const overdueKeys = Object.keys(grouped);
            if (overdueKeys.length === 0) {
                sectionOverdue.style.display = 'none';
            } else {
                sectionOverdue.style.display = 'block';
                overdueKeys.forEach(k => {
                    const item = grouped[k];
                    const diffDays = Math.ceil(Math.abs(now - item.dueDate) / (1000 * 60 * 60 * 24));
                    const card = document.createElement('div');
                    card.className = 'dashboard-card overdue';
                    card.innerHTML = `
                        <div class="card-title">${item.name}</div>
                        <div class="card-meta">
                            <span style="color:var(--status-overdue-text); font-weight:bold;">${diffDays} ${t('days_late')}</span>
                            <span>${t('vencido_hace')} ${item.dueDate.toLocaleDateString()}</span>
                        </div>`;
                    overdueList.appendChild(card);
                });
            }

            // 3. Upcoming
            const upcoming = [];
            const sevenDays = new Date(now);
            sevenDays.setDate(now.getDate() + 7);

            concepts.forEach(c => { // Payments
                if (c.validFrom <= currentMonthStr && (!c.validUntil || c.validUntil >= currentMonthStr)) {
                    const id = c.id;
                    const isPaid = currentData[id] === true;
                    const itemDate = new Date(currentYear, currentMonth, +c.inicio);
                    if (!isPaid && itemDate >= now && itemDate <= sevenDays) {
                        upcoming.push({ type: 'payment', name: c.nombre, date: itemDate });
                    }
                }
            });
            getAgenda().forEach(n => { // Agenda
                if (!n.date) return;
                const [y, m, d] = n.date.split('-').map(Number);
                const nDate = new Date(y, m - 1, d);
                if (nDate >= now && nDate <= sevenDays) {
                    upcoming.push({ type: 'agenda', name: n.text, date: nDate, time: n.time });
                }
            });
            upcoming.sort((a, b) => a.date - b.date);

            if (upcoming.length === 0) {
                upcomingList.innerHTML = `<div class="empty-state"><p>${t('no_upcoming')}</p></div>`;
            } else {
                upcoming.forEach(u => {
                    const card = document.createElement('div');
                    card.className = u.type === 'payment' ? 'dashboard-card upcoming' : 'dashboard-card';
                    card.innerHTML = `
                        <div class="card-title">${u.name}</div>
                        <div class="card-meta">
                            <span>${u.date.toLocaleDateString()}</span>
                            ${u.time ? `<span>üïê ${u.time}</span>` : ''}
                        </div>`;
                    upcomingList.appendChild(card);
                });
            }
        }



        /* --- CONCEPTS FILTER LOGIC --- */
        function populateConceptFilter() {
            const select = document.getElementById("filter-concept");
            if (!select) return;
            const currentVal = select.value;
            const concepts = getConcepts();

            // Keep "All" option
            select.innerHTML = '<option value="all">Concepto: Todos</option>';

            concepts.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
            });

            // Restore selection if possible, otherwise default to all
            if (currentVal && (currentVal === 'all' || concepts.find(c => c.id == currentVal))) {
                select.value = currentVal;
            } else {
                select.value = 'all';
            }
        }

        /* --- CORE LOGIC (Render) --- */
        function cargar() {
            const calGrid = document.getElementById("calendar-grid");
            const listaPagos = document.getElementById("listaPagos");
            const listaCitas = document.getElementById("listaTareas");

            calGrid.innerHTML = "";
            if (listaPagos) listaPagos.innerHTML = "";
            if (listaCitas) listaCitas.innerHTML = "";

            const mes = +mesSel.value;
            const anio = +anioSel.value;
            const key = `${anio}-${mes}`;
            const data = JSON.parse(localStorage.getItem(key)) || {};
            const currentMonthStr = `${anio}-${String(mes + 1).padStart(2, '0')}`;

            const now = new Date();
            const realYear = now.getFullYear();
            const realMonth = now.getMonth();
            const realDay = now.getDate();

            // Filters
            const filterType = document.getElementById("filter-type").value;
            const filterConceptEl = document.getElementById("filter-concept");
            const filterConceptId = filterConceptEl ? filterConceptEl.value : 'all';

            const items = [];

            // 1. Gather Payments
            if (filterType !== 'citas') {
                const concepts = getConcepts();
                concepts.forEach(c => {
                    // Concept Filter
                    if (filterConceptId !== 'all' && c.id != filterConceptId) return;
                    // Validity Filter
                    if (c.validFrom > currentMonthStr || (c.validUntil && c.validUntil < currentMonthStr)) return;

                    const isPaid = !!data[c.id];
                    if (filterType === 'completado' && !isPaid) return;
                    if (filterType === 'pendiente' && isPaid) return;

                    items.push({
                        type: 'payment',
                        id: c.id,
                        name: c.nombre,
                        start: +c.inicio,
                        end: c.fin || +c.inicio,
                        finMes: c.finMes,
                        paid: isPaid,
                        data: c
                    });
                });
            }

            // 2. Gather Agenda
            if (filterType !== 'pagos' && filterConceptId === 'all') {
                const notes = getAgenda();
                notes.forEach(n => {
                    if (!n.date) return;
                    const nDate = new Date(n.date + "T00:00:00");
                    if (nDate.getMonth() !== mes || nDate.getFullYear() !== anio) return;

                    const isPast = n.completed === true || (new Date() > new Date(n.date + "T23:59:59"));

                    // Filter
                    if (filterType === 'completado' && !isPast) return;
                    if (filterType === 'pendiente' && isPast) return;

                    items.push({
                        type: 'agenda',
                        id: n.id,
                        name: n.text,
                        start: nDate.getDate(),
                        end: nDate.getDate(),
                        paid: isPast, // Uses 'paid' prop for convenience
                        time: n.time,
                        data: n
                    });
                });
            }

            // 3. Render Calendar
            // Header
            ["Dom", "Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b"].forEach(d => {
                calGrid.innerHTML += `<div class="header">${d}</div>`;
            });

            // Days
            const firstDay = new Date(anio, mes, 1).getDay();
            const daysInMonth = new Date(anio, mes + 1, 0).getDate();

            // Empty slots
            for (let i = 0; i < firstDay; i++) calGrid.innerHTML += `<div class="day empty"></div>`;

            // Fill Days
            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement("div");
                const isToday = (i === realDay && mes === realMonth && anio === realYear);
                dayCell.className = `day ${isToday ? 'today' : ''}`;

                // Date Number
                dayCell.innerHTML = `<strong>${i}</strong>`;

                // Container for dots
                const dotsContainer = document.createElement("div");
                dotsContainer.className = "dots-container";

                // Items for this day
                const dayPayments = items.filter(p => p.type === 'payment' && p.start === i);
                const dayAppointments = items.filter(a => a.type === 'agenda' && a.start === i);

                // Render Payment Dots
                dayPayments.forEach(p => {
                    const dot = document.createElement("div");
                    dot.className = "gasto"; // Base dot class

                    // Status Logic for Class
                    if (p.paid) dot.classList.add("pagado");
                    else {
                        // Check if overdue
                        const isPast = (anio < realYear) || (anio === realYear && mes < realMonth) || (anio === realYear && mes === realMonth && i < realDay);
                        if (isPast) dot.classList.add("vencido");
                        else dot.classList.add("pendiente");
                    }

                    dot.title = `${p.name}`; // Tooltip
                    dotsContainer.appendChild(dot);
                });

                // Render Appointment Dots
                dayAppointments.forEach(a => {
                    const dot = document.createElement("div");
                    dot.className = "gasto agenda-item"; // Blue dot
                    if (a.paid) dot.style.opacity = "0.5"; // Completed

                    dot.title = `${a.name}`;
                    dotsContainer.appendChild(dot);
                });

                dayCell.appendChild(dotsContainer);
                calGrid.appendChild(dayCell);
            }

            // 4. Render Checklists
            if (!listaPagos || !listaCitas) return; // Safety

            const payments = items.filter(i => i.type === 'payment');
            const appointments = items.filter(i => i.type === 'agenda');

            // --- Helper for Colors ---
            const getStatusColor = (targetDay, isPaid) => {
                if (isPaid) return { bg: "var(--status-paid-bg)", border: "var(--status-paid-text)", text: "var(--status-paid-text)" };

                // Logic for Pending
                const isPastMonth = anio < realYear || (anio === realYear && mes < realMonth);
                const isFutureMonth = anio > realYear || (anio === realYear && mes > realMonth);
                const isCurrentMonth = anio === realYear && mes === realMonth;

                if (isPastMonth) return { bg: "var(--chk-bg-overdue)", border: "var(--chk-border-overdue)", text: "var(--chk-text-overdue)" };
                if (isFutureMonth) return { bg: "var(--chk-bg-future)", border: "var(--chk-border-future)", text: "var(--chk-text-future)" };

                if (isCurrentMonth) {
                    if (realDay > targetDay) return { bg: "var(--chk-bg-overdue)", border: "var(--chk-border-overdue)", text: "var(--chk-text-overdue)" };
                    const diff = targetDay - realDay;
                    if (diff <= 7) return { bg: "var(--chk-bg-upcoming)", border: "var(--chk-border-upcoming)", text: "var(--chk-text-upcoming)" };
                    return { bg: "var(--chk-bg-future)", border: "var(--chk-border-future)", text: "var(--chk-text-future)" };
                }
                return { bg: "var(--bg-panel)", border: "transparent", text: "var(--text-primary)" };
            };

            // Render Payments
            if (payments.length === 0) {
                listaPagos.innerHTML = `<div class="empty-state">No hay pagos.</div>`;
            } else {
                payments.forEach(p => {
                    const div = document.createElement("div");
                    const styles = getStatusColor(p.start, p.paid);

                    div.className = "dashboard-card checkbox-card";
                    div.style.backgroundColor = styles.bg;
                    div.style.borderLeft = `4px solid ${styles.border}`;

                    div.innerHTML = `
                        <div class="card-content">
                            <span class="card-title" style="color:var(--text-primary); font-size:14px;">${p.name} ${p.data.mandatory ? '<span style="color:var(--status-overdue-text);font-weight:bold;margin-left:5px;">!</span>' : ''}</span>
                            <div class="card-meta" style="color:var(--text-secondary); font-size:11px;">D√≠a ${p.start}</div>
                        </div>
                        <div class="card-action">
                             <input type="checkbox" ${p.paid ? "checked" : ""} class="custom-checkbox">
                        </div>
                    `;
                    div.querySelector("input").onchange = (e) => {
                        data[p.id] = e.target.checked;
                        localStorage.setItem(key, JSON.stringify(data));
                        cargar();
                    };
                    listaPagos.appendChild(div);
                });
            }

            // Render Appointments
            if (appointments.length === 0) {
                listaCitas.innerHTML = `<div class="empty-state">No hay citas.</div>`;
            } else {
                appointments.forEach(a => {
                    const div = document.createElement("div");
                    // Logic for Agenda Colors
                    let styles = { bg: "var(--chk-bg-default)", border: "transparent", text: "var(--text-primary)" };

                    if (a.paid) { // Completed
                        styles = { bg: "var(--status-paid-bg)", border: "var(--status-paid-text)", text: "var(--status-paid-text)" };
                    } else {
                        // Pending logic
                        const targetDay = a.start;
                        const isPastMonth = anio < realYear || (anio === realYear && mes < realMonth);
                        const isFutureMonth = anio > realYear || (anio === realYear && mes > realMonth);
                        const isCurrentMonth = anio === realYear && mes === realMonth;

                        if (isPastMonth) styles = { bg: "var(--chk-bg-overdue)", border: "var(--chk-border-overdue)", text: "var(--chk-text-overdue)" };
                        else if (isFutureMonth) styles = { bg: "var(--chk-bg-future)", border: "var(--chk-border-future)", text: "var(--chk-text-future)" };
                        else if (isCurrentMonth) {
                            if (realDay > targetDay) styles = { bg: "var(--chk-bg-overdue)", border: "var(--chk-border-overdue)", text: "var(--chk-text-overdue)" };
                            else if ((targetDay - realDay) <= 7) styles = { bg: "var(--chk-bg-upcoming)", border: "var(--chk-border-upcoming)", text: "var(--chk-text-upcoming)" };
                            else styles = { bg: "var(--chk-bg-future)", border: "var(--chk-border-future)", text: "var(--chk-text-future)" };
                        }
                    }

                    div.className = "dashboard-card checkbox-card";
                    div.style.backgroundColor = styles.bg;
                    div.style.borderLeft = `4px solid ${styles.border}`;

                    if (a.data.skipped) {
                        div.style.opacity = "0.6";
                        div.style.textDecoration = "line-through";
                    }

                    div.innerHTML = `
                        <div class="card-content">
                            <span class="card-title" style="color:var(--text-primary); font-size:14px;">${a.name}</span>
                            <div class="card-meta" style="color:var(--text-secondary); font-size:11px;">${a.time || ''}</div>
                        </div>
                        <div class="card-action">
                            <input type="checkbox" ${a.paid ? "checked" : ""} class="custom-checkbox" title="Marcar como Completado">
                        </div>
                    `;
                    div.querySelector("input").onchange = (e) => {
                        const allNotes = getAgenda();
                        const idx = allNotes.findIndex(n => n.id == a.id);
                        if (idx !== -1) {
                            allNotes[idx].completed = e.target.checked;
                            localStorage.setItem("agenda", JSON.stringify(allNotes));
                            cargar();
                        }
                    };
                    listaCitas.appendChild(div);
                });
            }
        }

        // Events
        mesSel.onchange = cargar;
        anioSel.onchange = cargar;

        /* --- DROPDOWN LOGIC --- */
        function toggleAddMenu() {
            const menu = document.getElementById('add-menu');
            if (menu) menu.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const menu = document.getElementById('add-menu');
            const button = document.querySelector('button[onclick="toggleAddMenu()"]');
            if (menu && button && !menu.contains(event.target) && !button.contains(event.target)) {
                menu.classList.remove('show');
            }
        });

        /* --- INITIALIZATION --- */
        function initApp() {
            try {
                // 1. Ensure Theme
                initTheme();

                // 2. Ensure Data Migration & Integrity
                const concepts = getConcepts();
                if (!concepts || concepts.length === 0) {
                    console.warn("No concepts found during init.");
                }

                // 3. Populate Filters
                populateConceptFilter();

                // 4. Initial Render
                renderAgenda();

                // 5. Force Dashboard View
                // Small delay to ensuring DOM painting if needed, but usually not required with this structure
                // RequestAF or setTimeout(0)
                setTimeout(() => {
                    switchView('dashboard');
                    renderDashboard(); // Double force render
                }, 50);

            } catch (error) {
                console.error("Initialization Failed:", error);
                alert("Error iniciando la aplicaci√≥n: " + error.message);
            }
        }

        // Run Init
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

    </script>

    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js");
        }
    </script>

</body>

</html>