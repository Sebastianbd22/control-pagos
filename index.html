<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#202c33">
    <title>Control de Pagos</title>

    <style>
        /* --- VARIABLES & THEME --- */
        :root {
            /* Light Mode */
            --bg-app: #f4f7f6;
            --bg-sidebar: #ffffff;
            --bg-panel: #ffffff;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --accent: #0984e3;
            /* Modern Blue */
            --accent-hover: #74b9ff;
            --border-color: #dfe6e9;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --card-radius: 12px;

            /* Status Colors */
            --status-paid-bg: #e0fadc;
            /* Softer Green */
            --status-paid-text: #25bb39;
            --status-pending-bg: #fff3e0;
            --status-pending-text: #f39c12;
            --status-overdue-bg: #ffebee;
            --status-overdue-text: #e74c3c;

            /* Calendar specific */
            --cal-bg: #ffffff;
            --cal-header: #f8f9fa;
            --cal-border: #dfe6e9;
            --day-hover: #f1f2f6;
        }

        body.dark-mode {
            --bg-app: #1e272e;
            --bg-sidebar: #2d3436;
            --bg-panel: #2d3436;
            --text-primary: #dfe6e9;
            --text-secondary: #b2bec3;
            --accent: #74b9ff;
            --accent-hover: #0984e3;
            --border-color: #353b48;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.2);

            --status-paid-bg: rgba(37, 187, 57, 0.15);
            --status-paid-text: #55efc4;
            --status-pending-bg: rgba(243, 156, 18, 0.15);
            --status-pending-text: #ffeaa7;
            --status-overdue-bg: rgba(231, 76, 60, 0.15);
            --status-overdue-text: #ff7675;

            --cal-bg: #2d3436;
            --cal-header: #353b48;
            --cal-border: #353b48;
            --day-hover: #3d464d;
        }

        * {
            box-sizing: border-box;
        }

        /* Fix for copy/paste issues */
        input,
        textarea {
            -webkit-user-select: text !important;
            user-select: text !important;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            /* Clean font */
            background: var(--bg-app);
            color: var(--text-primary);
            margin: 0;
            height: 100vh;
            height: 100dvh;
            display: flex;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* --- LAYOUT --- */
        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
            max-width: 1800px;
            margin: 0 auto;
            background: var(--bg-app);
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 70px;
            /* Slightly wider */
            background: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 25px;
            border-right: 1px solid var(--border-color);
            z-index: 100;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.02);
        }

        .nav-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            /* Soft square */
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            background: transparent;
            border: none;
        }

        .nav-btn:hover {
            background: var(--bg-app);
            color: var(--accent);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--accent);
            color: #fff;
            /* Active is solid accent now */
            box-shadow: 0 4px 10px rgba(9, 132, 227, 0.3);
        }

        .nav-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-app);
            /* App bg, panels will be white */
            position: relative;
            overflow: hidden;
        }

        .top-bar {
            height: 70px;
            background: var(--bg-panel);
            display: flex;
            align-items: center;
            padding: 0 30px;
            border-bottom: 1px solid var(--border-color);
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .top-bar h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            /* Prevent overflow */
        }

        /* Fixed Selects */
        select {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-app);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            cursor: pointer;
            transition: border 0.2s;
            min-width: 100px;
            /* Ensure readability */
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        select:hover {
            border-color: var(--accent);
        }

        /* --- VIEWS --- */
        .view-section {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .view-section.active {
            display: block;
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- DASHBOARD REDESIGN --- */
        .dashboard-container {
            max-width: 1200px;
            /* Wider for grid */
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            /* Masonry-like */
            gap: 24px;
            padding-bottom: 80px;
        }

        .db-header-card {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            color: white;
            padding: 25px;
            border-radius: var(--card-radius);
            box-shadow: 0 8px 20px rgba(9, 132, 227, 0.25);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .db-stat {
            text-align: center;
        }

        .db-stat .label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .db-stat .value {
            font-size: 28px;
            font-weight: 700;
            margin-top: 5px;
        }

        .dashboard-section {
            background: var(--bg-panel);
            border-radius: var(--card-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .dashboard-section.wide {
            grid-column: 1 / -1;
        }

        .dashboard-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .dashboard-card {
            background: var(--bg-app);
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            background: var(--bg-sidebar);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .dashboard-card.overdue {
            background: var(--status-overdue-bg);
            border-left: 4px solid var(--status-overdue-text);
        }

        .dashboard-card.overdue .card-title {
            color: var(--status-overdue-text);
        }

        .dashboard-card.upcoming {
            background: var(--bg-app);
            border-left: 4px solid var(--accent);
        }

        .card-title {
            font-weight: 600;
            font-size: 15px;
        }

        .card-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        /* --- CHECKLIST LISTA --- */
        .checklist-container {
            background: var(--bg-panel);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            border-bottom: 1px solid var(--border-color);
            transition: 0.2s;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item:hover {
            background: var(--bg-app);
        }

        .item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        /* --- CALENDAR --- */
        .calendar-wrapper {
            background: var(--bg-panel);
            border-radius: var(--card-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .day strong {
            background: var(--bg-app);
            /* Default date circle bg */
            font-size: 12px;
            width: 26px;
            height: 26px;
            line-height: 26px;
            border-radius: 50%;
            text-align: center;
        }

        .today strong {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 5px rgba(9, 132, 227, 0.4);
        }

        .gasto {
            padding: 4px 8px;
            margin-top: 2px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .pendiente {
            background: var(--status-pending-bg);
            color: var(--status-pending-text);
        }

        .pagado {
            background: var(--status-paid-bg);
            color: var(--status-paid-text);
            text-decoration: none;
            opacity: 0.8;
        }

        .vencido {
            background: var(--status-overdue-bg) !important;
            color: var(--status-overdue-text) !important;
        }

        /* --- SETTINGS --- */
        .settings-container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--bg-panel);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .btn-toggle {
            background: var(--text-secondary);
            color: var(--bg-panel);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn-toggle.active {
            background: var(--accent);
            color: white;
        }

        /* AGENDA ITEM IN CALENDAR */
        .agenda-item {
            background: rgba(33, 150, 243, 0.15) !important;
            color: #1976d2 !important;
        }

        body.dark-mode .agenda-item {
            background: rgba(33, 150, 243, 0.2) !important;
            color: #64b5f6 !important;
        }

        /* --- MOBILE --- */
        @media (max-width: 700px) {
            .app-container {
                flex-direction: column-reverse;
                /* Sidebar at bottom */
            }

            .sidebar {
                width: 100%;
                height: auto;
                min-height: 60px;
                flex-direction: row;
                justify-content: space-around;
                padding-top: 5px;
                padding-bottom: calc(5px + env(safe-area-inset-bottom));
                border-right: none;
                border-top: 1px solid var(--border-color);
                background: var(--bg-sidebar);
                flex-shrink: 0;
                z-index: 1000;
            }

            .nav-btn {
                margin-bottom: 0;
                width: 50px;
                height: 50px;
            }

            .nav-btn svg {
                width: 32px;
                height: 32px;
            }

            /* CALENDAR FIX */
            .calendar {
                gap: 1px;
                width: 100%;
                /* Ensure it fits container */
            }

            .day {
                min-height: 50px;
                font-size: 10px;
                padding: 2px;
                /* Reduce padding */
                overflow: hidden;
                /* Prevent spillover */
                min-width: 0;
                /* Allow grid items to shrink below content size */
            }

            .gasto {
                font-size: 8px;
                /* Smaller font */
                padding: 1px 2px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100%;
                /* Ensure text truncates */
            }

            /* AGENDA FIX */
            .agenda-container {
                width: 100%;
                /* Fit width */
                padding: 0 10px 80px 10px;
                /* Add side padding, keep bottom space */
                box-sizing: border-box;
                /* Include padding in width */
            }

            .agenda-input-area {
                flex-wrap: wrap;
                /* Allow inputs to wrap if needed */
                gap: 5px;
                padding: 10px;
            }

            .agenda-input {
                width: 100%;
                /* Full width input */
                margin-bottom: 5px;
            }

            .agenda-date {
                flex: 1;
                /* Share space */
            }

            .btn-add {
                margin-left: auto;
                /* Push to right */
            }
        }

        /* --- AGENDA VIEW --- */
        .agenda-container {
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 80px;
            /* Space for content */
        }

        .agenda-input-area {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }

        .agenda-input {
            flex: 1;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-sidebar);
            color: var(--text-primary);
            outline: none;
            font-size: 14px;
        }

        .agenda-date {
            padding: 8px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            background: var(--bg-sidebar);
            color: var(--text-primary);
            font-size: 12px;
            font-family: inherit;
        }

        .btn-add {
            background: var(--accent);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .note-card {
            background: var(--bg-panel);
            margin: 10px 15px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .note-body {
            font-size: 15px;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .btn-delete-note {
            background: transparent;
            border: none;
            color: #ef5350;
            font-size: 18px;
            cursor: pointer;
            padding: 0 5px;
        }

        /* --- DASHBOARD --- */
        .dashboard-container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        .dashboard-section {
            margin-bottom: 30px;
        }

        .dashboard-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dashboard-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: 0.2s;
        }

        .dashboard-card:hover {
            background: var(--bg-sidebar);
        }

        .dashboard-card.overdue {
            border-left: 4px solid #d32f2f;
            background: rgba(244, 67, 54, 0.05);
        }

        body.dark-mode .dashboard-card.overdue {
            background: rgba(244, 67, 54, 0.1);
        }

        .dashboard-card .card-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 5px;
        }

        .dashboard-card .card-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 15px;
            opacity: 0.3;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <!-- SIDEBAR NAVIGATION -->
        <aside class="sidebar">
            <button class="nav-btn active" onclick="switchView('dashboard')" title="Dashboard">
                <!-- HOME ICON -->
                <svg viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                </svg>
            </button>
            <button class="nav-btn" onclick="switchView('checklist')" title="Lista de Pagos">
                <!-- CHECK ICON -->
                <svg viewBox="0 0 24 24">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                </svg>
            </button>
            <button class="nav-btn" onclick="switchView('calendar')" title="Calendario">
                <!-- CALENDAR ICON -->
                <svg viewBox="0 0 24 24">
                    <path
                        d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" />
                </svg>
            </button>
            <button class="nav-btn" onclick="switchView('agenda')" title="Agenda">
                <!-- NOTEBOOK ICON -->
                <svg viewBox="0 0 24 24">
                    <path
                        d="M3 17h2v5H3zM3 10h2v5H3zM3 3h2v5H3zM9 17h12v-2H9v2zm2-9v-2h-2v2h2zm-2 5h12v-2H9v2zM15 3H9v2h2v4h2V5h2V3z" />
                </svg>
            </button>
            <button class="nav-btn" onclick="switchView('settings')" title="Configuraci√≥n">
                <!-- SETTINGS/GEAR ICON -->
                <svg viewBox="0 0 24 24">
                    <path
                        d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23-.41-.12-.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
                </svg>
            </button>
        </aside>

        <!-- MAIN AREA -->
        <main class="main-content">
            <!-- TOP BAR -->
            <div class="top-bar">
                <h2 id="page-title">Dashboard</h2>
                <div id="date-controls" class="controls" style="display:none;">
                    <select id="mes"></select>
                    <select id="anio"></select>
                </div>
                <div id="filter-controls" class="controls" style="display:none;">
                    <select id="filter-type">
                        <option value="all">Todo</option>
                        <option value="pagos">Pagos</option>
                        <option value="citas">Citas</option>
                        <option value="completado">Completado</option>
                        <option value="pendiente" selected>Pendiente</option>
                    </select>
                    <select id="filter-concept">
                        <option value="all">Concepto: Todos</option>
                    </select>
                </div>
                <button id="settings-icon" onclick="switchView('settings')" title="Configuraci√≥n"
                    style="background:transparent; border:none; cursor:pointer; padding:8px;">
                    <!-- Settings icon -->
                    <svg width="24" height="24" fill="var(--text-secondary)" viewBox="0 0 24 24">
                        <path
                            d="M19.43 12.98c.04-.32.07-.64.07-.98 0-.34-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.09-.16-.26-.25-.44-.25-.06 0-.12.01-.17.03l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.06-.02-.12-.03-.18-.03-.17 0-.34.09-.43.25l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98 0 .33.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.09.16.26.25.44.25.06 0 .12-.01.17-.03l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.06.02.12.03.18.03.17 0 .34-.09.43.25l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zm-1.98-1.71c.04.31.05.52.05.73 0 .21-.02.43-.05.73l-.14 1.13.89.7 1.08.84-.7 1.21-1.27-.51-1.04-.42-.9.68c-.43.32-.84.56-1.25.73l-1.06.43-.16 1.13-.2 1.35h-1.4l-.19-1.35-.16-1.13-1.06-.43c-.43-.18-.83-.41-1.23-.71l-.91-.7-1.06.43-1.27.51-.7-1.21 1.08-.84.89-.7-.14-1.13c-.03-.31-.05-.54-.05-.74s.02-.43.05-.73l.14-1.13-.89-.7-1.08-.84.7-1.21 1.27.51 1.04.42.9-.68c.43-.32.84-.56 1.25-.73l1.06-.43.16-1.13.2-1.35h1.39l.19 1.35.16 1.13 1.06.43c.43.18.83.41 1.23.71l.91-.7 1.06-.43 1.27-.51.7 1.21-1.07.85-.89.7.14 1.13zM12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z" />
                    </svg>
                </button>
            </div>

            <!-- VIEW: DASHBOARD -->
            <div id="dashboard" class="view-section active">
                <div class="dashboard-container">
                    <div class="db-header-card">
                        <div>
                            <h2 style="margin:0; font-size:24px;">Hola! üëã</h2>
                            <span style="opacity:0.8; font-size:14px;">Total del mes</span>
                        </div>
                        <div class="db-stat">
                            <div class="label">Pendiente</div>
                            <div class="value" id="db-total-pending">$0</div>
                        </div>
                    </div>

                    <div class="dashboard-section" id="section-overdue" style="display:none;">
                        <h3>‚ö†Ô∏è Pagos Vencidos</h3>
                        <div id="overdue-list"></div>
                    </div>

                    <div class="dashboard-section">
                        <h3>üìÖ Pr√≥ximos 7 D√≠as</h3>
                        <div id="upcoming-list"></div>
                    </div>

                    <div class="dashboard-section">
                        <h3>üìä Resumen Mensual</h3>
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span>Pagado</span>
                            <strong style="color:var(--status-paid-text)" id="db-total-paid">$0</strong>
                        </div>
                        <div
                            style="width:100%; background:var(--bg-app); height:8px; border-radius:4px; overflow:hidden;">
                            <div id="db-progress-bar"
                                style="width:0%; background:var(--accent); height:100%; transition:width 0.5s;"></div>
                        </div>
                        <small style="display:block; margin-top:5px; color:var(--text-secondary); text-align:right;"
                            id="db-progress-text">0% Completado</small>
                    </div>
                </div>
            </div>

            <!-- VIEW: CHECKLIST -->
            <div id="checklist" class="view-section">
                <!-- Payments Section -->
                <h3 class="checklist-header" data-i18n="pending_payments">Pagos Pendientes</h3>
                <div class="checklist-container" id="listaPagos">
                    <!-- Items injected by JS -->
                </div>

                <!-- Tasks/Agenda Section -->
                <h3 class="checklist-header" style="margin-top:30px;" data-i18n="todo_list">Por Hacer / Citas</h3>
                <div class="checklist-container" id="listaTareas">
                    <!-- Tasks injected by JS -->
                </div>
            </div>

            <!-- VIEW: CALENDAR -->
            <div id="calendar" class="view-section">
                <div class="calendar-wrapper">
                    <div class="calendar" id="calendar-grid">
                        <!-- Calendar injected by JS -->
                    </div>
                </div>
            </div>

            <!-- VIEW: AGENDA -->
            <div id="agenda" class="view-section">
                <div class="agenda-input-area" style="flex-direction:column; align-items:stretch;">
                    <input type="hidden" id="note-id">
                    <input type="text" id="note-input" class="agenda-input" placeholder="T√≠tulo / Tarea..."
                        style="width:100%; font-weight:bold;">
                    <textarea id="note-desc" class="agenda-input" placeholder="Descripci√≥n / Detalles (Opcional)..."
                        style="width:100%; min-height:60px; resize:vertical; font-family:inherit;"></textarea>

                    <div style="display:flex; gap:10px;">
                        <input type="date" id="note-date" class="agenda-date">
                        <input type="time" id="note-time" class="agenda-date">
                        <button class="btn-add" id="btn-save-note" onclick="saveNote()"
                            style="margin-left:auto; width:auto; padding:0 15px; border-radius:15px;">
                            Guardar
                        </button>
                        <button id="btn-cancel-edit" onclick="resetNoteInput()"
                            style="display:none; background:transparent; border:1px solid var(--text-secondary); color:var(--text-secondary); padding:0 10px; border-radius:15px; cursor:pointer;">
                            Cancelar
                        </button>
                    </div>
                </div>
                <div class="agenda-container" id="agenda-list">
                    <!-- Notes injected by JS -->
                </div>
            </div>

            <!-- VIEW: SETTINGS -->
            <div id="settings" class="view-section">
                <div class="settings-container">
                    <h3 data-i18n="settings">Configuraci√≥n</h3>

                    <div class="setting-item">
                        <span data-i18n="language">Idioma</span>
                        <select id="lang-select" onchange="changeLanguage(this.value)" style="width: auto;">
                            <option value="es">Espa√±ol</option>
                            <option value="en">English</option>
                        </select>
                    </div>

                    <div class="setting-item">
                        <span data-i18n="dark_mode">Modo Oscuro</span>
                        <button class="btn-toggle" id="theme-toggle" onclick="toggleTheme()">Activar</button>
                    </div>
                </div>

                <div class="settings-container" style="margin-top: 20px;">
                    <h3>Gesti√≥n de Datos</h3>

                    <div class="setting-item">
                        <span>Conceptos de Pago</span>
                        <button class="btn-toggle" onclick="openConceptManager()">Gestionar</button>
                    </div>

                    <div class="setting-item">
                        <span>Copia de Seguridad</span>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-toggle" onclick="exportData()"
                                title="Descargar archivo JSON">Exportar</button>
                            <label class="btn-toggle" style="cursor:pointer; position:relative;"
                                title="Cargar archivo JSON">
                                Importar
                                <input type="file" id="import-file" onchange="importData(this)"
                                    style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;"
                                    accept=".json">
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: CONCEPT MANAGER (Hidden initially) -->
            <div id="concept-manager" class="view-section">
                <div class="top-bar">
                    <button onclick="closeConceptManager()"
                        style="background:none; border:none; color:var(--text-primary); font-size:24px; cursor:pointer;">‚Üê</button>
                    <h2>Conceptos de Pago</h2>
                    <button onclick="openEditModal()"
                        style="background:var(--accent); color:white; border:none; width:36px; height:36px; border-radius:50%; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center;">+</button>
                </div>
                <div class="checklist-container" id="concepts-list" style="padding-top:20px;">
                    <!-- Concepts injected by JS -->
                </div>
            </div>

            <!-- MODAL: EDIT CONCEPT -->
            <div id="edit-modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
                <div
                    style="background:var(--bg-panel); padding:20px; border-radius:12px; width:90%; max-width:400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid var(--border-color);">
                    <h3 style="margin-top:0; color:var(--text-primary);">Editar Concepto</h3>

                    <input type="hidden" id="edit-id">

                    <div style="margin-bottom:15px;">
                        <label
                            style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">Nombre</label>
                        <input type="text" id="edit-nombre" class="agenda-input" style="width:100%;"
                            placeholder="Ej. Netflix">
                    </div>

                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <div style="flex:1;">
                            <label
                                style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">D√≠a
                                Inicio</label>
                            <input type="number" id="edit-inicio" class="agenda-input" style="width:100%;" min="1"
                                max="31">
                        </div>
                        <div style="flex:1;">
                            <label
                                style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">D√≠a
                                Fin</label>
                            <input type="number" id="edit-fin" class="agenda-input" style="width:100%;" min="1"
                                max="31">
                        </div>
                    </div>

                    <div style="margin-bottom:15px;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                            <input type="checkbox" id="edit-finMes"
                                style="width:18px; height:18px; accent-color:var(--accent);">
                            <span style="color:var(--text-primary); font-size:14px;">Pagar a Fin de Mes</span>
                        </label>
                    </div>

                    <hr style="border:0; border-top:1px solid var(--border-color); margin:15px 0;">

                    <div style="margin-bottom:15px;">
                        <label
                            style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">V√°lido
                            Desde (Mes/A√±o)</label>
                        <input type="month" id="edit-validFrom" class="agenda-input" style="width:100%;">
                    </div>

                    <div style="margin-bottom:20px;">
                        <label
                            style="display:block; font-size:12px; color:var(--text-secondary); margin-bottom:5px;">V√°lido
                            Hasta (Opcional)</label>
                        <input type="month" id="edit-validUntil" class="agenda-input" style="width:100%;">
                    </div>

                    <div style="display:flex; justify-content:flex-end; gap:10px;">
                        <button onclick="closeEditModal()" class="btn-toggle"
                            style="background:transparent; color:var(--text-secondary); border:1px solid var(--border-color);">Cancelar</button>
                        <button onclick="saveConcept()" class="btn-toggle"
                            style="background:var(--accent); color:white;">Guardar</button>
                        <button onclick="deleteConcept()" id="btn-delete-concept" class="btn-toggle"
                            style="background:#ef5350; color:white; margin-right:auto;">Eliminar</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        /* --- DATA --- */
        const defaultPagos = [
            { nombre: "BBVA Tarjeta Cr√©dito", inicio: 1, fin: 15 },
            { nombre: "RappiCard", inicio: 1, fin: 9 },
            { nombre: "Seguro Vehicular", inicio: 10, fin: 15 },
            { nombre: "Ahorro Viajes", inicio: 15, finMes: true },
            { nombre: "Pr√©stamo Maylin", inicio: 10, fin: 15 },
            { nombre: "Pr√©stamo BBVA", inicio: 1, fin: 10 },
            { nombre: "Agua", inicio: 20, finMes: true },
            { nombre: "Luz", inicio: 20, fin: 26 },
            { nombre: "Gas", inicio: 1, fin: 15 },
            { nombre: "Claro Hogar", inicio: 3, fin: 18 },
            { nombre: "Administraci√≥n", inicio: 1, fin: 5 },
            { nombre: "Claro M√≥vil", inicio: 3, fin: 15 },
            { nombre: "Universidad", inicio: 1, fin: 5 } // Added by request
        ];

        const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        /* --- DOM ELEMENTS --- */
        const mesSel = document.getElementById("mes");
        const anioSel = document.getElementById("anio");
        const calGrid = document.getElementById("calendar-grid");
        const listaPagos = document.getElementById("listaPagos");
        const pageTitle = document.getElementById("page-title");
        const dateControls = document.getElementById("date-controls");

        /* --- INITIALIZATION & TRANSLATIONS --- */
        for (let i = 0; i < 12; i++) mesSel.innerHTML += `<option value="${i}">${meses[i]}</option>`;

        /* --- TRANSLATIONS --- */
        const translations = {
            es: {
                home: "Inicio",
                checklist: "Pagos",
                calendar: "Calendario",
                agenda: "Agenda",
                settings: "Configuraci√≥n",
                pending_payments: "Pagos Pendientes",
                todo_list: "Por Hacer / Citas",
                language: "Idioma",
                dark_mode: "Modo Oscuro",
                overdue_title: "‚ö†Ô∏è Pagos Vencidos",
                upcoming_7_days: "üìÖ Pr√≥ximos 7 D√≠as",
                monthly_summary: "üìä Resumen Mensual",
                paid: "Pagado",
                completed: "Completado",
                days_late: "d√≠as de retraso",
                vencido_hace: "Vencido hace",
                pending_count: "Pendiente",
                no_upcoming: "No hay eventos pr√≥ximos",
                all_up_to_date: "¬°Todo al d√≠a!",
                delete_note_confirm: "¬øBorrar nota?",
                delete_concept_confirm: "¬øEliminar este concepto? Se perder√° el historial asociado."
            },
            en: {
                home: "Home",
                checklist: "Checklist",
                calendar: "Calendar",
                agenda: "Agenda",
                settings: "Settings",
                pending_payments: "Pending Payments",
                todo_list: "To-Do / Appointments",
                language: "Language",
                dark_mode: "Dark Mode",
                overdue_title: "‚ö†Ô∏è Overdue Payments",
                upcoming_7_days: "üìÖ Next 7 Days",
                monthly_summary: "üìä Monthly Summary",
                paid: "Paid",
                completed: "Completed",
                days_late: "days late",
                vencido_hace: "Overdue by",
                pending_count: "Pending",
                no_upcoming: "No upcoming events",
                all_up_to_date: "All caught up!",
                delete_note_confirm: "Delete note?",
                delete_concept_confirm: "Delete this concept? Associated history will be lost."
            }
        };

        function getLang() { return localStorage.getItem('lang') || 'es'; }
        function t(key) { return translations[getLang()][key] || key; }

        function changeLanguage(lang) {
            localStorage.setItem('lang', lang);
            updateTexts();
            const view = document.querySelector('.view-section.active');
            if (view) switchView(view.id);
        }

        function updateTexts() {
            const lang = getLang();
            const sel = document.getElementById('lang-select');
            if (sel) sel.value = lang;

            const navBtns = document.querySelectorAll('.nav-btn label');
            if (navBtns.length >= 5) {
                navBtns[0].textContent = t('home');
                navBtns[1].textContent = t('checklist');
                navBtns[2].textContent = t('calendar');
                navBtns[3].textContent = t('agenda');
                navBtns[4].textContent = t('settings');
            }

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });

            // Dynamic headers
            const overdueTitle = document.querySelector('#section-overdue h3');
            if (overdueTitle) overdueTitle.textContent = t('overdue_title');
            const sections = document.querySelectorAll('.dashboard-section h3');
            sections.forEach(h3 => {
                if (h3.textContent.includes('D√≠as')) h3.textContent = t('upcoming_7_days');
                if (h3.textContent.includes('Resumen')) h3.textContent = t('monthly_summary');
            });
        }

        // YEAR LOGIC
        function detectActiveYears() {
            let minYear = 2026;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.match(/^(\d{4})-\d{1,2}$/)) {
                    const y = parseInt(key.split('-')[0]);
                    if (y < minYear) minYear = y;
                }
            }
            return minYear;
        }

        const startYear = detectActiveYears();
        for (let y = startYear; y <= 2035; y++) anioSel.innerHTML += `<option value="${y}">${y}</option>`;




        const hoy = new Date();
        mesSel.value = hoy.getMonth();
        anioSel.value = hoy.getFullYear();

        /* --- THEME LOGIC --- */
        const themeToggleBtn = document.getElementById("theme-toggle");

        function initTheme() {
            const isDark = localStorage.getItem('theme') === 'dark';
            if (isDark) {
                document.body.classList.add('dark-mode');
                themeToggleBtn.textContent = "Desactivar";
                themeToggleBtn.classList.add('active');
            }
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            themeToggleBtn.textContent = isDark ? "Desactivar" : "Activar";
            themeToggleBtn.classList.toggle('active');
        }

        /* --- NAVIGATION LOGIC --- */
        function switchView(viewName) {
            // Hide all views: remove active class AND clear specific display overrides
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                el.style.display = ''; // Clear inline display styles (fixes locked views)
            });
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));

            // Show selected
            document.getElementById(viewName).classList.add('active');

            // Update Sidebar Icon - now includes dashboard at index 0
            const btnIndex = viewName === 'dashboard' ? 0 : viewName === 'checklist' ? 1 : viewName === 'calendar' ? 2 : viewName === 'agenda' ? 3 : 4;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            if (document.querySelectorAll('.nav-btn')[btnIndex]) {
                document.querySelectorAll('.nav-btn')[btnIndex].classList.add('active');
            }

            const pageTitle = document.getElementById('page-title');
            const dateControls = document.getElementById('date-controls');
            const filterControls = document.getElementById('filter-controls');

            // Update Title & Controls visibility
            // Update Title & Controls visibility
            if (viewName === 'dashboard') {
                pageTitle.textContent = t('home');
                dateControls.style.display = 'none';
                filterControls.style.display = 'none';
                renderDashboard();
            } else if (viewName === 'checklist') {
                pageTitle.textContent = t('checklist');
                dateControls.style.display = 'flex';
                filterControls.style.display = 'flex';
                cargar();
            } else if (viewName === 'calendar') {
                pageTitle.textContent = t('calendar');
                dateControls.style.display = 'flex';
                filterControls.style.display = 'flex';
                cargar();
            } else if (viewName === 'agenda') {
                pageTitle.textContent = t('agenda');
                dateControls.style.display = 'none';
                filterControls.style.display = 'none';
                renderAgenda();
            } else {
                pageTitle.textContent = t('settings');
                dateControls.style.display = 'none';
                filterControls.style.display = 'none';
            }
        }

        /* --- PAYMENT CONCEPTS MANAGEMENT --- */
        function getConcepts() {
            let concepts = JSON.parse(localStorage.getItem("concepts"));

            if (!concepts) {
                // First run: Initialize all defaults
                concepts = defaultPagos.map((p, idx) => ({
                    ...p,
                    id: Date.now() + idx,
                    validFrom: "2024-01",
                    validUntil: null
                }));
                localStorage.setItem("concepts", JSON.stringify(concepts));
            } else {
                // Sync Check: Ensure all defaultPagos exist (by name)
                // This handles the case where the USER updates the code (adds 'Universidad') 
                // but their LocalStorage is old.
                let changed = false;
                defaultPagos.forEach(def => {
                    const exists = concepts.some(c => c.nombre === def.nombre);
                    if (!exists) {
                        concepts.push({
                            ...def,
                            id: Date.now() + Math.floor(Math.random() * 1000), // Random offset to avoid ID collision
                            validFrom: new Date().toISOString().slice(0, 7), // Valid from NOW
                            validUntil: null
                        });
                        changed = true;
                    }
                });

                if (changed) saveConcepts(concepts);
            }
            return concepts;
        }

        function saveConcepts(concepts) {
            localStorage.setItem("concepts", JSON.stringify(concepts));
            populateConceptFilter();
        }

        function openConceptManager() {
            document.getElementById('settings').style.display = 'none';
            document.getElementById('concept-manager').style.display = 'block';
            document.getElementById('concept-manager').classList.add('active');
            renderConceptsList();
        }

        function closeConceptManager() {
            document.getElementById('concept-manager').style.display = 'none';
            document.getElementById('concept-manager').classList.remove('active');
            document.getElementById('settings').style.display = 'block';
            document.getElementById('settings').classList.add('active');
            cargar(); // Refresh main views with potential changes
        }

        function renderConceptsList() {
            const list = document.getElementById("concepts-list");
            list.innerHTML = "";
            const concepts = getConcepts();

            if (concepts.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-secondary)">No hay conceptos.</div>`;
                return;
            }

            concepts.forEach(c => {
                const div = document.createElement("div");
                div.className = "item";
                div.style.cursor = "pointer";
                div.onclick = (e) => {
                    // Prevent triggering if clicking something else inside (if exists)
                    openEditModal(c.id);
                };

                let periodText = `<small style="display:block; color:var(--text-secondary); font-size:11px;">Desde: ${c.validFrom}`;
                if (c.validUntil) periodText += ` ¬∑ Hasta: ${c.validUntil}`;
                else periodText += ` ¬∑ Indefinido`;
                periodText += `</small>`;

                div.innerHTML = `
                    <div style="flex:1;">
                        <span style="font-weight:500">${c.nombre}</span>
                        ${periodText}
                    </div>
                    <span style="font-size:12px; color:var(--text-secondary)">D√≠a ${c.inicio}</span>
                `;
                list.appendChild(div);
            });
        }

        function openEditModal(id = null) {
            const modal = document.getElementById("edit-modal");
            const concepts = getConcepts();

            document.getElementById("edit-id").value = id || "";

            if (id) {
                const c = concepts.find(x => x.id == id);
                if (c) {
                    document.getElementById("edit-nombre").value = c.nombre;
                    document.getElementById("edit-inicio").value = c.inicio;
                    document.getElementById("edit-fin").value = c.fin || "";
                    document.getElementById("edit-finMes").checked = !!c.finMes;
                    document.getElementById("edit-validFrom").value = c.validFrom || "";
                    document.getElementById("edit-validUntil").value = c.validUntil || "";
                    document.getElementById("btn-delete-concept").style.display = "block";
                }
            } else {
                // New
                document.getElementById("edit-nombre").value = "";
                document.getElementById("edit-inicio").value = "1";
                document.getElementById("edit-fin").value = "";
                document.getElementById("edit-finMes").checked = false;

                // Set default "From" to current month
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                document.getElementById("edit-validFrom").value = currentMonth;
                document.getElementById("edit-validUntil").value = "";

                document.getElementById("btn-delete-concept").style.display = "none";
            }

            modal.style.display = "flex";
        }

        function closeEditModal() {
            document.getElementById("edit-modal").style.display = "none";
        }

        function saveConcept() {
            const id = document.getElementById("edit-id").value;
            const nombre = document.getElementById("edit-nombre").value.trim();
            const inicio = parseInt(document.getElementById("edit-inicio").value);
            const finStr = document.getElementById("edit-fin").value;
            const fin = finStr ? parseInt(finStr) : null;
            const finMes = document.getElementById("edit-finMes").checked;
            const validFrom = document.getElementById("edit-validFrom").value;
            const validUntil = document.getElementById("edit-validUntil").value || null;

            if (!nombre || !inicio || !validFrom) {
                alert("Nombre, D√≠a de Inicio y Fecha de Validez son obligatorios.");
                return;
            }

            let concepts = getConcepts();

            const newConcept = {
                id: id ? parseInt(id) : Date.now(),
                nombre,
                inicio,
                fin: fin || (finMes ? null : inicio), // If no end day and not end-of-month, default to start day (1 day window)
                finMes,
                validFrom,
                validUntil
            };

            if (id) {
                const idx = concepts.findIndex(c => c.id == id);
                if (idx !== -1) concepts[idx] = newConcept;
            } else {
                concepts.push(newConcept);
            }

            saveConcepts(concepts);
            closeEditModal();
            renderConceptsList();
        }

        function deleteConcept() {
            const id = document.getElementById("edit-id").value;
            if (!id) return;

            if (!confirm("¬øEliminar este concepto? Se perder√° el historial asociado si se borra.")) return;

            let concepts = getConcepts();
            concepts = concepts.filter(c => c.id != id);
            saveConcepts(concepts);
            closeEditModal();
            renderConceptsList();
        }

        /* --- IMPORT / EXPORT DATA --- */
        function exportData() {
            const concepts = getConcepts();
            const agenda = getAgenda();

            // Get all payment status keys
            const paymentHistory = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // keys like '2024-5', '2024-11' etc.
                if (key.match(/^\d{4}-\d{1,2}$/)) {
                    paymentHistory[key] = JSON.parse(localStorage.getItem(key));
                }
            }

            const data = {
                concepts,
                agenda,
                paymentHistory,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `backup_control_pagos_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (confirm("Al importar se reemplazar√°n los datos actuales. ¬øDeseas continuar?")) {
                        // Clear current data? Maybe selective overwrite is safer. 
                        // Let's overwrite known keys.

                        if (data.concepts) localStorage.setItem("concepts", JSON.stringify(data.concepts));
                        if (data.agenda) localStorage.setItem("agenda", JSON.stringify(data.agenda));

                        if (data.paymentHistory) {
                            // Clear old payment history keys first?? No, let's just merge/overwrite.
                            Object.keys(data.paymentHistory).forEach(key => {
                                localStorage.setItem(key, JSON.stringify(data.paymentHistory[key]));
                            });
                        }

                        alert("Datos importados correctamente.");
                        location.reload(); // Reload to refresh everything
                    }
                } catch (err) {
                    alert("Error al leer el archivo: " + err);
                }
            };
            reader.readAsText(file);
            // Reset input so same file can be selected again if needed
            input.value = '';
        }

        /* --- AGENDA LOGIC --- */
        const agendaList = document.getElementById("agenda-list");
        const noteIdInput = document.getElementById("note-id");
        const noteInput = document.getElementById("note-input");
        const noteDesc = document.getElementById("note-desc");
        const noteDate = document.getElementById("note-date");
        const noteTime = document.getElementById("note-time");
        const btnSaveNote = document.getElementById("btn-save-note");
        const btnCancelEdit = document.getElementById("btn-cancel-edit");

        function getAgenda() {
            return JSON.parse(localStorage.getItem("agenda")) || [];
        }

        function saveAgenda(data) {
            localStorage.setItem("agenda", JSON.stringify(data));
        }

        function saveNote() {
            const id = noteIdInput.value;
            const text = noteInput.value.trim();
            const desc = noteDesc.value.trim();
            const date = noteDate.value;
            const time = noteTime.value;

            if (!text) return;

            const notes = getAgenda();

            if (id) {
                const index = notes.findIndex(n => n.id == id);
                if (index !== -1) {
                    notes[index] = { ...notes[index], text, desc, date, time };
                }
            } else {
                const newNote = {
                    id: Date.now(),
                    text, desc,
                    date: date || null,
                    time: time || null,
                    completed: false,
                    created: new Date().toLocaleDateString()
                };
                notes.unshift(newNote);
            }

            saveAgenda(notes);
            resetNoteInput();
            renderAgenda();
            cargar();
        }

        function editNote(id) {
            const notes = getAgenda();
            const note = notes.find(n => n.id == id);
            if (!note) return;

            noteIdInput.value = note.id;
            noteInput.value = note.text;
            noteDesc.value = note.desc || "";
            noteDate.value = note.date || "";
            noteTime.value = note.time || "";

            btnSaveNote.textContent = t('update') || "Actualizar";
            btnCancelEdit.style.display = "block";
            noteInput.focus();
            document.querySelector('.view-section.active').scrollTop = 0;
        }

        function resetNoteInput() {
            noteIdInput.value = "";
            noteInput.value = "";
            noteDesc.value = "";
            noteDate.value = "";
            noteTime.value = "";
            btnSaveNote.textContent = "Guardar";
            btnCancelEdit.style.display = "none";
        }

        function deleteNote(id) {
            if (!confirm(t('delete_note_confirm') || "¬øBorrar nota?")) return;
            const notes = getAgenda().filter(n => n.id !== id);
            saveAgenda(notes);
            if (noteIdInput.value == id) resetNoteInput();
            renderAgenda();
            cargar();
        }

        function renderAgenda() {
            const notes = getAgenda();
            agendaList.innerHTML = "";

            if (notes.length === 0) {
                agendaList.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-secondary)">${t('pending_count') || 'Pendiente'}... 0</div>`;
                return;
            }

            notes.forEach(n => {
                const displayDate = n.date ? new Date(n.date).toLocaleDateString() : n.created;
                const displayTime = n.time ? ` ‚Ä¢ ‚è∞ ${n.time}` : "";
                const descHtml = n.desc ? `<div style="margin-top:5px; font-size:13px; color:var(--text-secondary); white-space:pre-wrap;">${n.desc}</div>` : '';

                agendaList.innerHTML += `
                    <div class="note-card">
                        <div class="note-header">
                            <span>üìÖ ${displayDate}${displayTime}</span>
                            <div>
                                <button class="btn-delete-note" onclick="editNote(${n.id})" style="color:var(--accent); font-size:18px; margin-right:5px;">‚úé</button>
                                <button class="btn-delete-note" onclick="deleteNote(${n.id})">√ó</button>
                            </div>
                        </div>
                        <div class="note-body" style="font-weight:500;">${n.text}</div>
                        ${descHtml}
                    </div>
                `;
            });
        }

        /* --- DASHBOARD RENDERING --- */
        /* --- DASHBOARD RENDERING --- */
        function renderDashboard() {
            const overdueList = document.getElementById('overdue-list');
            const upcomingList = document.getElementById('upcoming-list');
            const sectionOverdue = document.getElementById('section-overdue');

            const elTotalPending = document.getElementById('db-total-pending');
            const elTotalPaid = document.getElementById('db-total-paid');
            const elProgressBar = document.getElementById('db-progress-bar');
            const elProgressText = document.getElementById('db-progress-text');

            overdueList.innerHTML = '';
            upcomingList.innerHTML = '';

            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            const currentMonthStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

            let countPending = 0;
            let countPaid = 0;
            const concepts = getConcepts();
            const currentKey = `${currentYear}-${currentMonth}`;
            const currentData = JSON.parse(localStorage.getItem(currentKey)) || {};

            // 1. Summary Stats
            concepts.forEach(c => {
                if (c.validFrom <= currentMonthStr && (!c.validUntil || c.validUntil >= currentMonthStr)) {
                    const isPaid = currentData[c.id] === true;
                    if (isPaid) countPaid++; else countPending++;
                }
            });
            const totalItems = countPaid + countPending;
            const percentage = totalItems === 0 ? 0 : Math.round((countPaid / totalItems) * 100);

            elTotalPending.textContent = countPending;
            elTotalPaid.textContent = countPaid;
            elProgressBar.style.width = `${percentage}%`;
            elProgressText.textContent = `${percentage}% ${t('completed')} (${countPaid}/${totalItems})`;

            // 2. Overdue Logic (Grouped)
            let scanStartYear = detectActiveYears();
            const rawOverdue = [];
            for (let year = scanStartYear; year <= currentYear; year++) {
                const endMonth = (year === currentYear) ? currentMonth : 11;
                for (let month = 0; month <= endMonth; month++) {
                    if (year === currentYear && month >= currentMonth) continue;
                    const key = `${year}-${month}`;
                    let data = JSON.parse(localStorage.getItem(key)) || {};
                    const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;

                    concepts.forEach(concept => {
                        if (concept.validFrom <= monthStr && (!concept.validUntil || concept.validUntil >= monthStr)) {
                            const isPaid = data[concept.id] === true;
                            if (!isPaid) {
                                rawOverdue.push({
                                    name: concept.nombre,
                                    dueDate: new Date(year, month, +concept.inicio),
                                    month: month + 1, year
                                });
                            }
                        }
                    });
                }
            }

            // Grouping
            const grouped = {};
            rawOverdue.forEach(o => {
                if (!grouped[o.name]) grouped[o.name] = { ...o, count: 0 };
                // Keep oldest date
                if (o.dueDate < grouped[o.name].dueDate) grouped[o.name].dueDate = o.dueDate;
                grouped[o.name].count++;
            });

            const overdueKeys = Object.keys(grouped);
            if (overdueKeys.length === 0) {
                sectionOverdue.style.display = 'none';
            } else {
                sectionOverdue.style.display = 'block';
                overdueKeys.forEach(k => {
                    const item = grouped[k];
                    const diffDays = Math.ceil(Math.abs(now - item.dueDate) / (1000 * 60 * 60 * 24));
                    const card = document.createElement('div');
                    card.className = 'dashboard-card overdue';
                    card.innerHTML = `
                        <div class="card-title">${item.name}</div>
                        <div class="card-meta">
                            <span style="color:var(--status-overdue-text); font-weight:bold;">‚ö†Ô∏è ${diffDays} ${t('days_late')}</span>
                            <span>${t('vencido_hace')} ${item.dueDate.toLocaleDateString()}</span>
                        </div>`;
                    overdueList.appendChild(card);
                });
            }

            // 3. Upcoming
            const upcoming = [];
            const sevenDays = new Date(now);
            sevenDays.setDate(now.getDate() + 7);

            concepts.forEach(c => { // Payments
                if (c.validFrom <= currentMonthStr && (!c.validUntil || c.validUntil >= currentMonthStr)) {
                    const id = c.id;
                    const isPaid = currentData[id] === true;
                    const itemDate = new Date(currentYear, currentMonth, +c.inicio);
                    if (!isPaid && itemDate >= now && itemDate <= sevenDays) {
                        upcoming.push({ type: 'payment', name: c.nombre, date: itemDate });
                    }
                }
            });
            getAgenda().forEach(n => { // Agenda
                if (!n.date) return;
                const [y, m, d] = n.date.split('-').map(Number);
                const nDate = new Date(y, m - 1, d);
                if (nDate >= now && nDate <= sevenDays) {
                    upcoming.push({ type: 'agenda', name: n.text, date: nDate, time: n.time });
                }
            });
            upcoming.sort((a, b) => a.date - b.date);

            if (upcoming.length === 0) {
                upcomingList.innerHTML = `<div class="empty-state"><p>${t('no_upcoming')}</p></div>`;
            } else {
                upcoming.forEach(u => {
                    const card = document.createElement('div');
                    card.className = u.type === 'payment' ? 'dashboard-card upcoming' : 'dashboard-card';
                    card.innerHTML = `
                        <div class="card-title">${u.type === 'payment' ? 'üí≥' : 'üìÖ'} ${u.name}</div>
                        <div class="card-meta">
                            <span>${u.date.toLocaleDateString()}</span>
                            ${u.time ? `<span>üïê ${u.time}</span>` : ''}
                        </div>`;
                    upcomingList.appendChild(card);
                });
            }
        }



        /* --- CONCEPTS FILTER LOGIC --- */
        function populateConceptFilter() {
            const select = document.getElementById("filter-concept");
            if (!select) return;
            const currentVal = select.value;
            const concepts = getConcepts();

            // Keep "All" option
            select.innerHTML = '<option value="all">Concepto: Todos</option>';

            concepts.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
            });

            // Restore selection if possible, otherwise default to all
            if (currentVal && (currentVal === 'all' || concepts.find(c => c.id == currentVal))) {
                select.value = currentVal;
            } else {
                select.value = 'all';
            }
        }

        /* --- CORE LOGIC (Render) --- */
        function cargar() {
            const calGrid = document.getElementById("calendar-grid");
            const listaPagos = document.getElementById("lista-pagos");
            const listaCitas = document.getElementById("lista-citas");

            calGrid.innerHTML = "";
            if (listaPagos) listaPagos.innerHTML = "";
            if (listaCitas) listaCitas.innerHTML = "";

            const mes = +mesSel.value;
            const anio = +anioSel.value;
            const key = `${anio}-${mes}`;
            const data = JSON.parse(localStorage.getItem(key)) || {};
            const currentMonthStr = `${anio}-${String(mes + 1).padStart(2, '0')}`;

            // Filters
            const filterType = document.getElementById("filter-type").value;
            const filterConceptEl = document.getElementById("filter-concept");
            const filterConceptId = filterConceptEl ? filterConceptEl.value : 'all';

            const items = [];

            // 1. Gather Payments
            if (filterType !== 'citas') {
                const concepts = getConcepts();
                concepts.forEach(c => {
                    // Concept Filter
                    if (filterConceptId !== 'all' && c.id != filterConceptId) return;
                    // Validity Filter
                    if (c.validFrom > currentMonthStr || (c.validUntil && c.validUntil < currentMonthStr)) return;

                    const isPaid = !!data[c.id];
                    if (filterType === 'completado' && !isPaid) return;
                    if (filterType === 'pendiente' && isPaid) return;

                    items.push({
                        type: 'payment',
                        id: c.id,
                        name: c.nombre,
                        start: +c.inicio,
                        end: c.fin || +c.inicio,
                        finMes: c.finMes,
                        paid: isPaid,
                        data: c
                    });
                });
            }

            // 2. Gather Agenda
            if (filterType !== 'pagos' && filterConceptId === 'all') {
                const notes = getAgenda();
                notes.forEach(n => {
                    if (!n.date) return;
                    const nDate = new Date(n.date + "T00:00:00");
                    if (nDate.getMonth() !== mes || nDate.getFullYear() !== anio) return;

                    const isPast = n.completed === true || (new Date() > new Date(n.date + "T23:59:59"));

                    // Filter
                    if (filterType === 'completado' && !isPast) return;
                    if (filterType === 'pendiente' && isPast) return;

                    items.push({
                        type: 'agenda',
                        id: n.id,
                        name: n.text,
                        start: nDate.getDate(),
                        end: nDate.getDate(),
                        paid: isPast, // Uses 'paid' prop for convenience
                        time: n.time,
                        data: n
                    });
                });
            }

            // 3. Render Calendar
            // Header
            ["Dom", "Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b"].forEach(d => {
                calGrid.innerHTML += `<div class="header">${d}</div>`;
            });

            // Days
            const firstDay = new Date(anio, mes, 1).getDay();
            const daysInMonth = new Date(anio, mes + 1, 0).getDate();
            const now = new Date();

            // Empty slots
            for (let i = 0; i < firstDay; i++) calGrid.innerHTML += `<div class="day empty"></div>`;

            // Filled slots
            for (let d = 1; d <= daysInMonth; d++) {
                const isToday = (d === now.getDate() && mes === now.getMonth() && anio === now.getFullYear());
                let cellHtml = `<div class="day ${isToday ? 'today' : ''}"><strong style="font-size:12px;display:block;margin-bottom:2px;">${d}</strong>`;

                // Items for this day
                items.forEach(item => {
                    let applies = false;
                    if (item.type === 'payment') {
                        applies = item.finMes ? d >= item.start : (d >= item.start && d <= item.end);
                    } else {
                        applies = d === item.start;
                    }

                    if (applies) {
                        let className = "gasto";
                        let statusColor = "";

                        // Overdue check for payments
                        const isOverdue = item.type === 'payment' && !item.paid && (anio < now.getFullYear() || (anio === now.getFullYear() && mes < now.getMonth()));

                        if (isOverdue) className += " vencido";
                        else if (item.paid) className += " pagado";
                        else className += " pendiente";

                        if (item.type === 'agenda') className += " agenda-item";

                        let label = item.name;
                        if (item.time) label = `üïí ${item.time} ${label}`;

                        cellHtml += `<div class="${className}" title="${label}">${label}</div>`;
                    }
                });
                cellHtml += `</div>`;
                calGrid.innerHTML += cellHtml;
            }

            // 4. Render Checklists
            if (!listaPagos || !listaCitas) return; // Safety

            const payments = items.filter(i => i.type === 'payment');
            const appointments = items.filter(i => i.type === 'agenda');

            // Render Payments
            if (payments.length === 0) listaPagos.innerHTML = `<div class="empty-state">No hay pagos.</div>`;
            payments.forEach(p => {
                const div = document.createElement("div");
                div.className = "item";
                div.innerHTML = `
                    <span>${p.name} <small style="color:var(--text-secondary)">(D√≠a ${p.start})</small></span>
                    <input type="checkbox" ${p.paid ? "checked" : ""}>
                `;
                div.querySelector("input").onchange = (e) => {
                    data[p.id] = e.target.checked;
                    localStorage.setItem(key, JSON.stringify(data));
                    cargar();
                };
                listaPagos.appendChild(div);
            });

            // Render Appointments
            if (appointments.length === 0) listaCitas.innerHTML = `<div class="empty-state">No hay citas.</div>`;
            appointments.forEach(a => {
                const div = document.createElement("div");
                div.className = "item";
                div.style.cursor = "default"; // No checkbox for agenda here, controlled in Agenda view mostly
                // But user asked for checklist. Let's add a "done" checkbox for agenda too?
                // "Restructure checklist into separate Valid Payments and Todo/Appointments"
                // Let's add a checkbox that updates 'completed' status for agenda.

                div.innerHTML = `
                    <span>${a.name} <small>${a.time || ''}</small></span>
                    <input type="checkbox" ${a.paid ? "checked" : ""}>
                `;
                div.querySelector("input").onchange = (e) => {
                    // Update agenda item
                    const allNotes = getAgenda();
                    const idx = allNotes.findIndex(n => n.id == a.id);
                    if (idx !== -1) {
                        allNotes[idx].completed = e.target.checked;
                        localStorage.setItem("agenda", JSON.stringify(allNotes));
                        cargar();
                    }
                };
                listaCitas.appendChild(div);
            });
        }

        // Events
        mesSel.onchange = cargar;
        anioSel.onchange = cargar;

        // Boostrap
        initTheme();
        populateConceptFilter();

        /* --- CLOUD SYNC --- */
        // Initial Load
        renderAgenda();
        cargar();

        // Initial Load
        renderAgenda();
        cargar();
        fetchCloudData(); // Try to get latest from cloud

    </script>

    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js");
        }
    </script>

</body>

</html>